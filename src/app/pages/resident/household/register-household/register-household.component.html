<main class="content">
  <div class="container-fluid p-0">
    <h1 class="h3 mb-3">Khai báo Nhân khẩu</h1>

    <div class="row">
      <!-- FORM -->
      <div class="col-12 col-lg-5">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Thêm thành viên</h5>
          </div>
          <div class="card-body">
            <form [formGroup]="memberForm" (ngSubmit)="onSubmit()">

              <!-- HỌ TÊN -->
              <div class="mb-3">
                <label class="form-label">
                  Họ và Tên <span class="text-danger">*</span>
                </label>
                <input type="text" class="form-control" formControlName="name" [class.is-invalid]="isInvalid('name')">
                <div class="invalid-feedback" *ngIf="memberForm.get('name')?.hasError('required')">
                  Vui lòng nhập họ tên.
                </div>
                <div class="invalid-feedback" *ngIf="memberForm.get('name')?.hasError('pattern')">
                  Họ tên chỉ được chứa chữ.
                </div>
              </div>

              <!-- QUAN HỆ -->
              <div class="mb-3">
                <label class="form-label">
                  Quan hệ với chủ hộ <span class="text-danger">*</span>
                </label>
                <select class="form-select" formControlName="familyRole" [class.is-invalid]="isInvalid('familyRole')">
                  <option [value]="null" disabled>-- Chọn quan hệ --</option>
                  <option value="Vợ">Vợ</option>
                  <option value="Chồng">Chồng</option>
                  <option value="Con">Con</option>
                  <option value="Bố">Bố</option>
                  <option value="Mẹ">Mẹ</option>
                  <option value="Khác">Khác</option>
                </select>
                <div class="invalid-feedback">Vui lòng chọn quan hệ.</div>
              </div>

              <!-- NGÀY SINH -->
              <div class="mb-3">
                <label class="form-label">
                  Ngày sinh <span class="text-danger">*</span>
                </label>
                <input type="date" class="form-control" formControlName="dateOfBirth"
                  [class.is-invalid]="isInvalid('dateOfBirth')">
                <div class="invalid-feedback">Vui lòng chọn ngày sinh.</div>
              </div>

              <!-- GIỚI TÍNH -->
              <div class="mb-3">
                <label class="form-label">Giới tính</label>
                <select class="form-select" formControlName="gender">
                  <option [value]="null">-- Chọn giới tính --</option>
                  <option value="Nam">Nam</option>
                  <option value="Nữ">Nữ</option>
                </select>
              </div>

              <!-- CCCD -->
              <div class="mb-3">
                <label class="form-label">
                  Số CCCD
                  <span class="text-danger" *ngIf="isIdRequired()"> *</span>
                </label>
                <input type="text" class="form-control" formControlName="idNumber"
                  [class.is-invalid]="isInvalid('idNumber')">

                <div class="invalid-feedback" *ngIf="memberForm.get('idNumber')?.hasError('required')">
                  Vui lòng nhập CCCD.
                </div>
                <div class="invalid-feedback" *ngIf="memberForm.get('idNumber')?.hasError('pattern')">
                  CCCD chỉ gồm chữ số.
                </div>
                <div class="invalid-feedback" *ngIf="memberForm.get('idNumber')?.hasError('idNumberExists')">
                  CCCD đã tồn tại.
                </div>
              </div>

              <!-- SĐT -->
              <div class="mb-3">
                <label class="form-label">Số điện thoại</label>
                <input type="tel" class="form-control" formControlName="phoneNumber"
                  [class.is-invalid]="memberForm.get('phoneNumber')?.hasError('pattern')">
                <div class="invalid-feedback">Số điện thoại chỉ gồm chữ số.</div>
              </div>

              <!-- ẢNH -->
              <div class="mb-3">
                <label class="form-label">Ảnh khuôn mặt</label>
                <input type="file" class="form-control" accept="image/*" (change)="onFileSelected($event)">
              </div>

              <!-- QUỐC TỊCH -->
              <div class="mb-3">
                <label class="form-label">Quốc tịch</label>
                <input type="text" class="form-control" formControlName="nationality">
              </div>

              <!-- SUBMIT -->
              <button type="submit" class="btn btn-success w-100"
                [disabled]="memberForm.invalid || memberForm.pending || isSubmitting()">
                <span *ngIf="isSubmitting()" class="spinner-border spinner-border-sm me-1"></span>
                Thêm thành viên
              </button>

              <div *ngIf="submitError()" class="alert alert-danger mt-3">
                {{ submitError() }}
              </div>

              <div *ngIf="submitSuccess()" class="alert alert-success mt-3">
                {{ submitSuccess() }}
              </div>

            </form>
          </div>
        </div>
      </div>

      <!-- DANH SÁCH -->
      <div class="col-12 col-lg-7">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Danh sách thành viên gia đình</h5>
          </div>
          <div class="card-body">
            <div *ngIf="isLoading()" class="text-center">
              <div class="spinner-border"></div>
            </div>

            <table *ngIf="!isLoading()" class="table table-striped">
              <thead>
                <tr>
                  <th>Ảnh</th>
                  <th>Họ tên</th>
                  <th>Quan hệ</th>
                  <th>CCCD</th>
                  <th>Ngày sinh</th>
                  <th>Giới Tính</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let m of members()">
                  <td>
                    <img [src]="m.faceImageUrl || 'https://ui-avatars.com/api/?name=' + m.name + '&background=random'"
                      alt="Ảnh" class="rounded-circle" width="40" height="40"
                      style="object-fit: cover; border: 1px solid #dee2e6;">
                  </td>
                  <td>{{ m.name }}</td>
                  <td>{{ m.familyRole }}</td>
                  <td>{{ m.idNumber }}</td>
                  <td>{{ m.dateOfBirth | date:'dd/MM/yyyy' }}</td>
                  <td>{{ m.gender }}</td>
                </tr>
              </tbody>
            </table>

          </div>
        </div>
      </div>

    </div>
  </div>
</main>
