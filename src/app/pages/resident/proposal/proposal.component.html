<div class="proposal-container">
    <mat-card class="proposal-form-card">
        <mat-card-header>
            <mat-card-title>Gửi Đề xuất/Khiếu nại mới</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <form [formGroup]="proposalForm" (ngSubmit)="onSubmit()">
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Nội dung đề xuất (Tối đa 2000 ký tự)</mat-label>
                    <textarea matInput 
                              formControlName="content" 
                              rows="4" 
                              placeholder="Nhập chi tiết đề xuất hoặc khiếu nại của bạn tại đây..." 
                              required></textarea>
                    <mat-error *ngIf="proposalForm.get('content')?.hasError('required')">
                        Nội dung đề xuất là bắt buộc.
                    </mat-error>
                    <mat-error *ngIf="proposalForm.get('content')?.hasError('maxlength')">
                        Nội dung không được vượt quá 2000 ký tự.
                    </mat-error>
                </mat-form-field>
                
                <mat-card-actions align="end">
                    <button mat-raised-button color="primary" type="submit" [disabled]="proposalForm.invalid || isSubmitting">
                        <span *ngIf="!isSubmitting"><mat-icon>send</mat-icon> Gửi Đề xuất</span>
                        <mat-progress-spinner *ngIf="isSubmitting" mode="indeterminate" diameter="20"></mat-progress-spinner>
                    </button>
                </mat-card-actions>
            </form>
        </mat-card-content>
    </mat-card>

    <mat-card class="proposal-history-card">
        <mat-card-header>
            <mat-card-title>Lịch sử Đề xuất của tôi</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <div *ngIf="history$ | async as history; else loadingOrEmpty">
                <div *ngIf="history.length > 0; else emptyHistory">
                    
                    <div *ngFor="let proposal of history" class="proposal-item">
                        <div class="proposal-header">
                            <span class="proposal-date">Ngày gửi: {{ proposal.createdAt | date:'short' }}</span>
                            <span class="proposal-status" [ngClass]="getStatusClass(proposal.status)">
                                {{ proposal.status }}
                            </span>
                        </div>
                        <p class="proposal-content">
                            <strong>Nội dung:</strong> {{ proposal.content }}
                        </p>
                        
                        <div *ngIf="proposal.reply" class="proposal-reply">
                            <strong>Phản hồi từ Staff:</strong> 
                            {{ proposal.reply }} ({{ proposal.operationStaffName }})
                        </div>
                        <div *ngIf="!proposal.reply" class="proposal-reply no-reply">
                            Chưa có phản hồi.
                        </div>
                        
                        <mat-divider></mat-divider>
                    </div>

                </div>
            </div>

            <ng-template #loadingOrEmpty>
                <div class="loading-state">Đang tải lịch sử đề xuất...</div>
            </ng-template>
            
            <ng-template #emptyHistory>
                <div class="loading-state">Bạn chưa có đề xuất nào.</div>
            </ng-template>
        </mat-card-content>
    </mat-card>
</div>