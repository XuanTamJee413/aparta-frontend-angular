<div class="container">
  <h2>Lịch sử đặt tiện ích</h2>

  <!-- Loading -->
  <div class="loading" *ngIf="isLoading && !bookingIdToCancel">
    Đang tải lịch sử đặt chỗ...
  </div>

  <!-- Có dữ liệu -->
  <div class="table-responsive" *ngIf="myBookings.length > 0">
    <table class="booking-table">
      <thead>
        <tr>
          <th>Tiện ích</th>
          <th>Thời gian sử dụng</th>
          <th>Ngày đặt</th>
          <th>Trạng thái</th>
          <th>Ghi chú của bạn</th>
          <th>Phản hồi nhân viên</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let b of myBookings" [class.expired]="isExpired(b.bookingDate)">
          <td class="utility-name">
            <strong>{{ b.utilityName }}</strong>
          </td>
          <td>
            {{ b.bookingDate | date:'dd/MM/yyyy HH:mm' }}
            <span class="expired-tag" *ngIf="isExpired(b.bookingDate)"> (Đã qua)</span>
          </td>
          <td>{{ b.bookedAt | date:'dd/MM/yyyy HH:mm' }}</td>
          <td>
            <span class="status-badge" [ngClass]="'status-' + b.status.toLowerCase()">
              {{ getStatusLabel(b.status) }}
            </span>
          </td>
          <td class="note">{{ b.residentNote || '—' }}</td>
          <td class="note">{{ b.staffNote || '—' }}</td>
          <td>
            <button 
              *ngIf="b.status === 'Pending' || b.status === 'Approved'"
              class="btn-cancel"
              [disabled]="isExpired(b.bookingDate)"
              (click)="openCancelModal(b.utilityBookingId)">
              Hủy
            </button>

            <span class="text-muted" *ngIf="b.status === 'Cancelled'">Đã hủy</span>
            <span class="text-muted" *ngIf="b.status === 'Rejected'">Bị từ chối</span>
            <span class="text-muted" *ngIf="!['Pending','Approved'].includes(b.status) && !isExpired(b.bookingDate)">
              —
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Không có dữ liệu -->
  <div class="empty-state" *ngIf="!isLoading && myBookings.length === 0">
    <p>Bạn chưa đặt tiện ích nào.</p>
    <a routerLink="/resident/utilities" class="btn-primary">Đặt tiện ích ngay</a>
  </div>
</div>

<!-- Dialog xác nhận hủy -->
<dialog #cancelDialog class="simple-dialog">
  <form class="dialog-form">
    <h3>Xác nhận hủy đặt chỗ</h3>
    <p>Bạn có chắc muốn <strong>hủy</strong> lịch đặt này?</p>
    <p class="note">Hành động này không thể hoàn tác.</p>

    <div class="error" *ngIf="cancelErrorMessage">
      {{ cancelErrorMessage }}
    </div>

    <div class="buttons">
      <button type="button" class="btn-secondary" (click)="closeCancelDialog()" [disabled]="isLoading">
        Hủy bỏ
      </button>
      <button type="button" class="btn-danger" (click)="confirmCancel()" [disabled]="isLoading">
        {{ isLoading ? 'Đang xử lý...' : 'Đồng ý hủy' }}
      </button>
    </div>
  </form>
</dialog>