<div class="container">
  <!-- BẢNG LƯU Ý NỔI BẬT - ĐẸP & CHUYÊN NGHIỆP -->
<div class="notice-card">
  <div class="notice-header">
    <h4>Lưu ý quan trọng khi đặt tiện ích chung</h4>
  </div>

  <ul class="notice-list">
    <li><strong>Tối đa 3 lần đặt/ngày</strong> </li>
    <li>Phải đặt <strong>trước ít nhất 60 phút</strong> so với giờ hiện tại</li>
    <li>Tổng thời gian đặt không được lớn hơn thời tối đa của tiện ích (tùy tiện ích)</li>
    <li>Chỉ được đặt trong <strong>khung giờ hoạt động</strong> của từng tiện ích</li>
    <li><strong>Không đặt trùng giờ</strong> với lịch của cư dân khác</li>
    <li>Có thể hủy <strong>trước khi lịch bắt đầu</strong></li>
    <li>Trong một số trường hợp đặc biệt<strong>, Chung cư có thể thu hồi lịch đặt</strong></li>
    <li>Vui lòng đặt đúng nhu cầu, tránh đặt giữ chỗ gây ảnh hưởng người khác</li>
  </ul>

  <div class="notice-footer">
    Cảm ơn Quý cư dân đã hợp tác để mọi người cùng sử dụng tiện ích công bằng!
  </div>
</div>

  <h2>Đăng Ký Tiện Ích</h2>

  <div *ngIf="pageSuccessMessage" class="alert alert-success">
    {{ pageSuccessMessage }}
  </div>

  <div class="utility-grid">
    <div *ngFor="let u of utilities" class="utility-card">
      <h3>{{ u.name }}</h3>
      <p><strong>Vị trí:</strong> {{ u.location }}</p>
      <p><strong>Thời gian tối đa:</strong> {{ u.periodTime }} giờ/lần</p>
      <p>
        <strong>Giờ mở cửa:</strong> 
        {{ u.openTime | slice:0:5 }} - {{ u.closeTime | slice:0:5 }}
      </p>
      <button class="btn-book" (click)="openBookingModal(u)">Đặt Ngay</button>
    </div>
    
    <div *ngIf="utilities.length === 0" class="empty-msg">
      Không có tiện ích nào đang hoạt động.
    </div>
  </div>

  <hr class="section-divider" />

  <h2>Lịch sử đặt tiện ích của tôi</h2>

  <div class="loading" *ngIf="isHistoryLoading">
    Đang tải lịch sử...
  </div>

  <div class="table-responsive" *ngIf="!isHistoryLoading && myBookings.length > 0">
    <table class="booking-table">
      <thead>
        <tr>
          <th>Tiện ích</th>
          <th>Thời gian</th>
          <th>Trạng thái</th>
          <th>Ghi chú</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let b of myBookings" [class.expired]="isExpired(b.bookingDate)">
          <td>
             <strong>{{ b.utilityName }}</strong>
          </td>
          <td>
            <div>Bắt đầu: {{ b.bookingDate | date:'dd/MM HH:mm' }}</div>
            <div>Kết thúc: {{ b.bookedAt | date:'dd/MM HH:mm' }}</div>
            <span class="expired-tag" *ngIf="isExpired(b.bookingDate)">(Đã qua)</span>
          </td>
          <td>
            <span class="status-badge" [ngClass]="'status-' + b.status.toLowerCase()">
              {{ getStatusLabel(b.status) }}
            </span>
          </td>
          <td>
             <div *ngIf="b.residentNote"><strong>Bạn:</strong> {{ b.residentNote }}</div>
             <div *ngIf="b.staffNote" class="text-danger"><strong>Phản hồi:</strong> {{ b.staffNote }}</div>
          </td>
          <td>
            <button 
              *ngIf="b.status === 'Pending' || b.status === 'Approved'"
              class="btn-cancel-sm"
              [disabled]="isExpired(b.bookingDate)"
              (click)="openCancelModal(b.utilityBookingId)">
              Hủy
            </button>
            <span *ngIf="b.status === 'Cancelled'" class="text-muted">Đã hủy</span>
            <span *ngIf="b.status === 'Rejected'" class="text-muted">Bị từ chối</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="!isHistoryLoading && myBookings.length === 0" class="empty-msg">
    Bạn chưa có lịch sử đặt chỗ nào.
  </div>

</div>

<dialog #bookingDialog (close)="closeDialog()" class="booking-modal">
  <form [formGroup]="bookingForm" (ngSubmit)="submitBooking()" class="booking-form">

    <div class="modal-header">
      <h3>Đặt tiện ích: {{ selectedUtility?.name }}</h3>
      <button type="button" class="btn-close" (click)="closeDialog()" aria-label="Đóng">×</button>
    </div>

    <div class="modal-body">

      <div class="form-group">
        <label for="startTime">Thời gian bắt đầu <span class="required">*</span></label>
        <input 
          id="startTime"
          type="datetime-local" 
          formControlName="bookingDate"
          #startDateInput
          (change)="onDateChange(startDateInput.value)"
          class="form-input">
        <small class="form-error" 
          *ngIf="bookingForm.get('bookingDate')?.invalid && bookingForm.get('bookingDate')?.touched">
          Vui lòng chọn thời gian bắt đầu.
        </small>
      </div>

      <div class="form-group">
        <label for="duration">Thời gian sử dụng (phút) <span class="required">*</span></label>
        <input 
          id="duration"
          type="number" 
          formControlName="duration"
          min="15"
          step="15" 
          class="form-input"
          placeholder="Nhập số phút (VD: 30, 60, 90...)">
        
        <small class="text-muted" *ngIf="selectedUtility?.periodTime">
          Tối đa: {{ selectedUtility!.periodTime! * 60 }} phút.
        </small>

        <small class="form-error" 
          *ngIf="bookingForm.get('duration')?.invalid && bookingForm.get('duration')?.touched">
          <span *ngIf="bookingForm.get('duration')?.errors?.['required']">Vui lòng nhập thời gian.</span>
          <span *ngIf="bookingForm.get('duration')?.errors?.['min']">Tối thiểu 15 phút.</span>
          <span *ngIf="bookingForm.get('duration')?.errors?.['max']">Vượt quá thời gian tối đa cho phép.</span>
        </small>
      </div>

      <div class="form-group info-box" *ngIf="calculatedEndTime">
        <p>
            Giờ kết thúc dự kiến: 
            <strong>{{ calculatedEndTime | date:'HH:mm dd/MM/yyyy' }}</strong>
        </p>
      </div>

      <div class="busy-slots" *ngIf="bookedSlots.length > 0">
        <div class="busy-header">
          <strong>Lịch đã kín trong ngày {{ selectedDate | date:'dd/MM/yyyy' }}:</strong>
        </div>
        <ul class="busy-list">
          <li *ngFor="let slot of bookedSlots">
            {{ slot.start | date:'HH:mm' }} → {{ slot.end | date:'HH:mm' }}
          </li>
        </ul>
      </div>

      <div class="form-group">
        <label for="note">Ghi chú (nếu có)</label>
        <textarea 
          id="note"
          formControlName="residentNote" 
          rows="3"
          class="form-textarea"></textarea>
      </div>

      <div class="alert alert-danger" *ngIf="dialogErrorMessage">
        {{ dialogErrorMessage }}
      </div>

    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-cancel" (click)="closeDialog()">Hủy bỏ</button>
      <button type="submit" class="btn btn-primary" [disabled]="isLoading || bookingForm.invalid">
        <span *ngIf="isLoading">Đang gửi...</span>
        <span *ngIf="!isLoading">Xác nhận đặt</span>
      </button>
    </div>

  </form>
</dialog>

<dialog #cancelDialog class="simple-dialog" (close)="closeCancelDialog()">
  <form class="dialog-form">
    <h3>Xác nhận hủy đặt chỗ</h3>
    <p>Bạn có chắc muốn hủy lịch này không? Hành động này không thể hoàn tác.</p>

    <div class="form-error" *ngIf="cancelErrorMessage">
      {{ cancelErrorMessage }}
    </div>

    <div class="form-footer">
      <button type="button" class="btn-cancel" (click)="closeCancelDialog()">Quay lại</button>
      <button type="button" class="btn-danger" (click)="confirmCancel()">
        {{ isLoading ? 'Đang xử lý...' : 'Đồng ý Hủy' }}
      </button>
    </div>
  </form>
</dialog>