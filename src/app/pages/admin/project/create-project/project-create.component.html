<div class="container">
  <div class="card">
    <header>
      <h1>Thêm mới Dự án</h1>
      <p>Nhập thông tin dự án, địa chỉ và tài khoản nhận thanh toán</p>
    </header>

    <form [formGroup]="createForm" (ngSubmit)="onSubmit()" class="mt-4">
      
      <h5 class="mb-3 text-primary border-bottom pb-2">Thông tin chung</h5>
      <div class="row">
        <div class="col-md-8 mb-3">
          <label class="form-label fw-bold">Tên dự án <span class="text-danger">*</span></label>
          <div class="position-relative">
            <input type="text" class="form-control" formControlName="name" placeholder="VD: Chung cư Times City">
            <span 
              *ngIf="createForm.get('name')?.value" 
              class="clear-icon" 
              (click)="clearProjectName()"
              title="Xóa tên dự án">
              ×
            </span>
          </div>
          <div *ngIf="createForm.get('name')?.invalid && createForm.get('name')?.touched" class="text-danger small mt-1">
            <span *ngIf="createForm.get('name')?.hasError('required')">Tên dự án là bắt buộc.</span>
            <span *ngIf="createForm.get('name')?.hasError('minlength')">Tên dự án phải có ít nhất 3 ký tự.</span>
            <span *ngIf="createForm.get('name')?.hasError('pattern')">Tên dự án chỉ được chứa chữ, số và các ký tự: ! _ -</span>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <label class="form-label fw-bold">Mã dự án <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="projectCode" placeholder="VD: CCTC2024">
          <div class="form-text text-muted small">Tự động sinh theo tên (Có thể sửa)</div>
          
          <!-- Checking status -->
          <div *ngIf="isCheckingProjectCode" class="text-primary small mt-1">
            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            {{ projectCodeCheckMessage }}
          </div>
          
          <!-- Duplicate warning -->
          <div *ngIf="!isCheckingProjectCode && projectCodeExists" class="text-danger small mt-1">
            {{ projectCodeCheckMessage }}
          </div>
          
          <!-- Valid message -->
          <div *ngIf="!isCheckingProjectCode && !projectCodeExists && projectCodeCheckMessage && createForm.get('projectCode')?.value" class="text-success small mt-1">
            {{ projectCodeCheckMessage }}
          </div>
          
          <!-- Pattern validation -->
          <div *ngIf="createForm.get('projectCode')?.hasError('pattern') && createForm.get('projectCode')?.touched" class="text-danger small mt-1">
            Mã không hợp lệ (Chỉ A-Z, 0-9, _).
          </div>
          
          <!-- Required validation -->
          <div *ngIf="createForm.get('projectCode')?.hasError('required') && createForm.get('projectCode')?.touched" class="text-danger small mt-1">
            Mã dự án là bắt buộc.
          </div>
        </div>
      </div>

      <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">Địa chỉ hành chính</h5>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Số nhà / Đường</label>
          <input type="text" class="form-control" formControlName="address" placeholder="458 Minh Khai">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Phường / Xã</label>
          <input type="text" class="form-control" formControlName="ward" placeholder="Vĩnh Tuy">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Quận / Huyện</label>
          <input type="text" class="form-control" formControlName="district" placeholder="Hai Bà Trưng">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Tỉnh / Thành phố</label>
          <input type="text" class="form-control" formControlName="city" placeholder="Hà Nội">
        </div>
      </div>

      <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">
        Cấu hình PayOS (Tùy chọn)
      </h5>
      <div class="info-box mb-3">
        <div class="info-content">
          <div class="info-title">
            <strong>Lưu ý:</strong>
          </div>
          <ul class="info-list">
            <li>
              Nếu không cấu hình PayOS, hệ thống sẽ sử dụng tài khoản PayOS mặc định từ cấu hình hệ thống
            </li>
            <li>
              Mỗi project có thể có tài khoản PayOS riêng để quản lý thanh toán độc lập
            </li>
            <li>
              <strong>Bắt buộc:</strong> Phải kiểm tra và xác thực tài khoản PayOS trước khi tạo dự án
            </li>
          </ul>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">
            PayOS Client ID
            <span class="text-muted" style="font-size: 0.75rem; font-weight: normal;">(Tùy chọn)</span>
          </label>
          <input type="text" class="form-control" formControlName="payOSClientId" 
                 placeholder="Nhập Client ID"
                 (input)="resetPayOSValidation()">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">
            PayOS API Key
            <span class="text-muted" style="font-size: 0.75rem; font-weight: normal;">(Tùy chọn)</span>
          </label>
          <input type="password" class="form-control" formControlName="payOSApiKey" 
                 placeholder="Nhập API Key"
                 (input)="resetPayOSValidation()">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">
            PayOS Checksum Key
            <span class="text-muted" style="font-size: 0.75rem; font-weight: normal;">(Tùy chọn)</span>
          </label>
          <input type="password" class="form-control" formControlName="payOSChecksumKey" 
                 placeholder="Nhập Checksum Key"
                 (input)="resetPayOSValidation()">
        </div>
        <div class="col-12 mb-3">
          <button type="button" class="btn btn-outline-primary" 
                  (click)="validatePayOS()" 
                  [disabled]="isValidatingPayOS || !createForm.get('payOSClientId')?.value || !createForm.get('payOSApiKey')?.value || !createForm.get('payOSChecksumKey')?.value">
            <span *ngIf="isValidatingPayOS">Đang kiểm tra...</span>
            <span *ngIf="!isValidatingPayOS">Kiểm tra tài khoản PayOS</span>
          </button>
          <div *ngIf="payOSValidationMessage" 
               class="mt-2" 
               [ngClass]="{
                 'text-success': payOSValidationStatus === 'valid',
                 'text-danger': payOSValidationStatus === 'invalid',
                 'text-info': payOSValidationStatus === 'idle'
               }">
            {{ payOSValidationMessage }}
          </div>
        </div>
      </div>

      <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">Tài khoản nhận thanh toán</h5>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">Ngân hàng</label>
          <input type="text" class="form-control" formControlName="bankName" value="PayOS" readonly>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Số tài khoản</label>
          <input type="text" class="form-control" formControlName="bankAccountNumber" 
                 placeholder="Sẽ tự động điền sau khi kiểm tra PayOS"
                 [readonly]="payOSValidationStatus === 'valid'">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Tên chủ tài khoản</label>
          <input type="text" class="form-control" formControlName="bankAccountName" 
                 placeholder="Sẽ tự động điền sau khi kiểm tra PayOS"
                 [readonly]="payOSValidationStatus === 'valid'">
        </div>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
        <a routerLink="/admin/project/list" class="btn btn-secondary">Hủy bỏ</a>
        <button type="submit" class="btn btn-primary" [disabled]="isSubmitting || createForm.invalid">
          {{ isSubmitting ? 'Đang lưu...' : 'Lưu Dự án' }}
        </button>
      </div>
    </form>
  </div>
</div>