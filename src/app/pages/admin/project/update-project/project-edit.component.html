<div class="container">
  <div class="card">
    <header>
      <h1>Cập nhật Dự án</h1>
      <p>Chỉnh sửa thông tin dự án và tài khoản</p>
    </header>

    <div *ngIf="isLoading" class="text-center my-4">Đang tải...</div>

    <form [formGroup]="editForm" (ngSubmit)="onSubmit()" *ngIf="!isLoading && currentProject" class="mt-4">
      
      <h5 class="mb-3 text-primary border-bottom pb-2">Thông tin chung</h5>
      <div class="row">
        <div class="col-md-8 mb-3">
          <label class="form-label fw-bold">Tên dự án <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="name">
        </div>

        <div class="col-md-4 mb-3">
          <label class="form-label fw-bold">Mã dự án</label>
          <input type="text" class="form-control bg-light fw-bold text-primary" formControlName="projectCode">
        </div>
        
        <div class="col-12 mb-3">
           <div class="form-check form-switch p-3 border rounded bg-light">
            <input class="form-check-input" type="checkbox" id="activeSwitch" formControlName="isActive" style="margin-left: 0; margin-right: 10px;">
            <label class="form-check-label fw-bold" for="activeSwitch">Trạng thái Hoạt động (Active)</label>
          </div>
        </div>
      </div>

      <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">Địa chỉ hành chính</h5>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Số nhà / Đường</label>
          <input type="text" class="form-control" formControlName="address">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Phường / Xã</label>
          <input type="text" class="form-control" formControlName="ward">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Quận / Huyện</label>
          <input type="text" class="form-control" formControlName="district">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Tỉnh / Thành phố</label>
          <input type="text" class="form-control" formControlName="city">
        </div>
      </div>

      <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">
        Cấu hình PayOS (Tùy chọn)
      </h5>
      <div class="info-box mb-3">
        <div class="info-content">
          <div class="info-title">
            <strong>Lưu ý:</strong>
          </div>
          <ul class="info-list">
            <li>
              Nếu không cấu hình PayOS, hệ thống sẽ sử dụng tài khoản PayOS mặc định từ cấu hình hệ thống
            </li>
            <li>
              Mỗi project có thể có tài khoản PayOS riêng để quản lý thanh toán độc lập
            </li>
            <li>
              <strong>Bắt buộc:</strong> Phải kiểm tra và xác thực tài khoản PayOS trước khi cập nhật dự án
            </li>
          </ul>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">
            PayOS Client ID
            <span class="text-muted" style="font-size: 0.75rem; font-weight: normal;">(Tùy chọn)</span>
          </label>
          <input type="text" class="form-control" formControlName="payOSClientId" 
                 placeholder="Nhập Client ID"
                 (input)="resetPayOSValidation()">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">
            PayOS API Key
            <span class="text-muted" style="font-size: 0.75rem; font-weight: normal;">(Tùy chọn)</span>
          </label>
          <input type="password" class="form-control" formControlName="payOSApiKey" 
                 placeholder="Nhập API Key"
                 (input)="resetPayOSValidation()">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">
            PayOS Checksum Key
            <span class="text-muted" style="font-size: 0.75rem; font-weight: normal;">(Tùy chọn)</span>
          </label>
          <input type="password" class="form-control" formControlName="payOSChecksumKey" 
                 placeholder="Nhập Checksum Key"
                 (input)="resetPayOSValidation()">
        </div>
        <div class="col-12 mb-3">
          <button type="button" class="btn btn-outline-primary" 
                  (click)="validatePayOS()" 
                  [disabled]="isValidatingPayOS || !editForm.get('payOSClientId')?.value || !editForm.get('payOSApiKey')?.value || !editForm.get('payOSChecksumKey')?.value">
            <span *ngIf="isValidatingPayOS">Đang kiểm tra...</span>
            <span *ngIf="!isValidatingPayOS">Kiểm tra tài khoản PayOS</span>
          </button>
          <div *ngIf="payOSValidationMessage" 
               class="mt-2" 
               [ngClass]="{
                 'text-success': payOSValidationStatus === 'valid',
                 'text-danger': payOSValidationStatus === 'invalid',
                 'text-info': payOSValidationStatus === 'idle'
               }">
            {{ payOSValidationMessage }}
          </div>
        </div>
      </div>

      <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">Tài khoản nhận thanh toán</h5>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label">Ngân hàng</label>
          <input type="text" class="form-control" formControlName="bankName" value="PayOS" readonly>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Số tài khoản</label>
          <input type="text" class="form-control" formControlName="bankAccountNumber" 
                 placeholder="Sẽ tự động điền sau khi kiểm tra PayOS"
                 [readonly]="payOSValidationStatus === 'valid'">
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label">Tên chủ tài khoản</label>
          <input type="text" class="form-control" formControlName="bankAccountName" 
                 placeholder="Sẽ tự động điền sau khi kiểm tra PayOS"
                 [readonly]="payOSValidationStatus === 'valid'">
        </div>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
        <a routerLink="/admin/project/list" class="btn btn-secondary">Quay lại</a>
        <button type="submit" class="btn btn-primary" [disabled]="isSubmitting || editForm.invalid">
          {{ isSubmitting ? 'Đang cập nhật...' : 'Lưu Thay Đổi' }}
        </button>
      </div>
    </form>
  </div>
</div>