<div class="container">
  <div class="card">
    <header>
      <div class="header-row">
        <div>
          <h1>Quản lý Gói dịch vụ</h1>
          <p>Danh sách các gói dịch vụ và lịch sử gia hạn</p>
        </div>
        <a class="btn-primary" (click)="openCreateModal()" title="Gia hạn mới gói dịch vụ">
          <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          Gia hạn mới
        </a>
      </div>
    </header>

    <mat-tab-group (selectedIndexChange)="onTabChange($event)" [selectedIndex]="currentTab === 'main' ? 0 : 1" animationDuration="0ms">
      
      <mat-tab label="Danh sách Chính">
        <div class="filter-container">
          
          <div class="filter-item">
            <span class="filter-label">Trạng thái</span>
            <select class="custom-select" [(ngModel)]="selectedStatus" (ngModelChange)="applyFilter()">
              <option *ngFor="let option of statusOptions" [value]="option.value">{{ option.label }}</option>
            </select>
          </div>

          <div class="filter-item">
            <span class="filter-label">Lọc theo</span>
            <select class="custom-select" [(ngModel)]="selectedDateType" (ngModelChange)="applyFilter()">
              <option *ngFor="let type of dateTypeOptions" [value]="type.value">{{ type.label }}</option>
            </select>
          </div>

          <div class="filter-item">
            <span class="filter-label">Từ ngày</span>
            <div style="position: relative;">
              <input class="custom-date" [matDatepicker]="startPicker" [(ngModel)]="fromDate" [max]="toDate" placeholder="dd/mm/yyyy" (click)="startPicker.open()">
              <mat-datepicker #startPicker></mat-datepicker>
            </div>
          </div>

          <div class="filter-item">
            <span class="filter-label">Đến ngày</span>
            <div style="position: relative;">
              <input class="custom-date" [matDatepicker]="endPicker" [(ngModel)]="toDate" [min]="fromDate" placeholder="dd/mm/yyyy" (click)="endPicker.open()">
              <mat-datepicker #endPicker></mat-datepicker>
            </div>
          </div>

          <div class="filter-item">
            <span class="filter-label" style="visibility: hidden;">Hành động</span>
            <div class="filter-actions">
              <button class="btn-primary" (click)="applyFilter()">
                <mat-icon style="font-size: 18px; width: 18px; height: 18px; margin-right: 4px;">filter_list</mat-icon> Lọc
              </button>
              <button class="btn-secondary" (click)="clearFilter()">
                <mat-icon style="font-size: 18px; width: 18px; height: 18px; margin-right: 4px;">clear</mat-icon> Xóa
              </button>
            </div>
          </div>

        </div>

        <div class="table-container">
          <div *ngIf="isLoading" class="loading-overlay">
            <div class="spinner"></div>
            <p>Đang tải dữ liệu...</p>
          </div>

          <div *ngIf="!isLoading" class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th style="width: 50px;">STT</th>
                  <th>Mã gói</th>
                  <th>Dự án</th>
                  <th>Thời hạn</th>
                  <th>Ngày hết hạn</th>
                  <th>Thanh toán</th>
                  <th>Ngày trả</th>
                  <th>Trạng thái</th>
                  <th class="text-center">Hành động</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let sub of subscriptions; let i = index">
                  <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>
                  <td><span class="font-mono">{{ sub.subscriptionCode }}</span></td>
                  <td>
                    <div class="font-medium">{{ sub.projectName }}</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">{{ sub.projectCode }}</div>
                  </td>
                  <td>
                     {{ calculateStartDate(sub) | date:'dd/MM/yyyy' }} 
                     <span style="color: #9ca3af; font-size: 0.75rem;">({{ sub.numMonths }} tháng)</span>
                  </td>
                  <td>{{ sub.expiredAt | date:'dd/MM/yyyy' }}</td>
                  <td>{{ sub.amountPaid ? (sub.amountPaid | number) + ' đ' : '-' }}</td>
                  <td>{{ sub.paymentDate ? (sub.paymentDate | date:'dd/MM/yyyy') : '-' }}</td>
                  <td>
                    <span class="status-badge" [ngClass]="getStatusClass(sub.status)">
                      {{ getStatusLabel(sub.status) }}
                    </span>
                  </td>
                  <td class="action-cell">
                    <div class="action-buttons">
                      <button class="btn-action btn-view" (click)="openViewModal(sub)" title="Xem chi tiết">
                        <mat-icon>visibility</mat-icon> Xem
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="subscriptions.length === 0">
                  <td colspan="9" class="no-results">
                    <mat-icon class="empty-icon">inbox</mat-icon>
                    <p>Không tìm thấy gói dịch vụ nào.</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="card-footer" *ngIf="!isLoading && totalCount > 0">
            <div class="pagination-summary">
              Hiển thị {{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize, totalCount) }} trong {{ totalCount }}
            </div>
            <div class="pagination-controls">
              <select class="page-size-select" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
                <option [ngValue]="5">5 / trang</option>
                <option [ngValue]="10">10 / trang</option>
                <option [ngValue]="20">20 / trang</option>
                <option [ngValue]="50">50 / trang</option>
              </select>
              <button class="btn-page" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">
                <mat-icon>chevron_left</mat-icon>
              </button>
              <span style="font-size: 14px; font-weight: 500; color: #374151;">Trang {{ currentPage }} / {{ totalPages }}</span>
              <button class="btn-page" [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">
                <mat-icon>chevron_right</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </mat-tab>

      <mat-tab label="Danh sách Nháp">
        <div class="filter-container">

          <div class="filter-item">
            <span class="filter-label">Tạo từ ngày</span>
            <div style="position: relative;">
              <input class="custom-date" [matDatepicker]="startPicker2" [(ngModel)]="fromDate" [max]="toDate" placeholder="dd/mm/yyyy" (click)="startPicker2.open()">
              <mat-datepicker #startPicker2></mat-datepicker>
            </div>
          </div>

          <div class="filter-item">
            <span class="filter-label">Đến ngày</span>
            <div style="position: relative;">
              <input class="custom-date" [matDatepicker]="endPicker2" [(ngModel)]="toDate" [min]="fromDate" placeholder="dd/mm/yyyy" (click)="endPicker2.open()">
              <mat-datepicker #endPicker2></mat-datepicker>
            </div>
          </div>

          <div class="filter-item">
            <span class="filter-label" style="visibility: hidden;">Hành động</span>
            <div class="filter-actions">
              <button class="btn-primary" (click)="applyFilter()">
                <mat-icon style="font-size: 18px; width: 18px; height: 18px; margin-right: 4px;">filter_list</mat-icon> Lọc
              </button>
              <button class="btn-secondary" (click)="clearFilter()">
                <mat-icon style="font-size: 18px; width: 18px; height: 18px; margin-right: 4px;">clear</mat-icon> Xóa
              </button>
            </div>
          </div>
        </div>

        <div class="table-container">
           <div *ngIf="isLoading" class="loading-overlay">
            <div class="spinner"></div>
            <p>Đang tải dữ liệu...</p>
          </div>

          <div *ngIf="!isLoading" class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th style="width: 50px;">STT</th>
                  <th>Mã gói</th>
                  <th>Dự án</th>
                  <th>Số tháng</th>
                  <th>Giá gốc</th>
                  <th>Đã thanh toán</th>
                  <th>Ngày tạo</th>
                  <th>Trạng thái</th>
                  <th class="text-center">Hành động</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let sub of subscriptions; let i = index">
                  <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>
                  <td><span class="font-mono">{{ sub.subscriptionCode }}</span></td>
                  <td>
                    <div class="font-medium">{{ sub.projectName }}</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">{{ sub.projectCode }}</div>
                  </td>
                  <td>{{ sub.numMonths }} tháng</td>
                  <td>{{ sub.amount | number }} đ</td>
                  <td>{{ sub.amountPaid ? (sub.amountPaid | number) + ' đ' : '-' }}</td>
                  <td>{{ sub.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
                  <td>
                    <span class="status-badge status-draft">Nháp</span>
                  </td>
                  <td class="action-cell">
                    <div class="action-buttons">
                      <button class="btn-action btn-edit" (click)="openEditModal(sub)" title="Chỉnh sửa">
                        <mat-icon>edit</mat-icon> Sửa
                      </button>
                      <button class="btn-action btn-delete" (click)="openDeleteDialog(sub)" title="Xóa">
                        <mat-icon>delete</mat-icon> Xóa
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="subscriptions.length === 0">
                   <td colspan="9" class="no-results">
                    <mat-icon class="empty-icon">inbox</mat-icon>
                    <p>Không có bản nháp nào.</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

           <div class="card-footer" *ngIf="!isLoading && totalCount > 0">
            <div class="pagination-summary">
              Hiển thị {{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize, totalCount) }} trong {{ totalCount }}
            </div>
            <div class="pagination-controls">
              <select class="page-size-select" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
                <option [ngValue]="5">5 / trang</option>
                <option [ngValue]="10">10 / trang</option>
                <option [ngValue]="20">20 / trang</option>
                <option [ngValue]="50">50 / trang</option>
              </select>
              <button class="btn-page" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">
                <mat-icon>chevron_left</mat-icon>
              </button>
              <span style="font-size: 14px; font-weight: 500; color: #374151;">Trang {{ currentPage }} / {{ totalPages }}</span>
              <button class="btn-page" [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">
                <mat-icon>chevron_right</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </mat-tab>

    </mat-tab-group>
  </div>
</div>