<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="card-title mb-0">Quản lý Gói dịch vụ</h3>
          <button mat-raised-button color="primary" (click)="openCreateModal()">
            <mat-icon>add</mat-icon> Thêm mới
          </button>
        </div>
        
        <div class="card-body">
          <!-- Tabs -->
          <mat-tab-group (selectedIndexChange)="onTabChange($event)" [selectedIndex]="currentTab === 'main' ? 0 : 1">
            <mat-tab label="Danh sách Chính">
              <!-- Filter Section -->
              <div class="filter-section">
                <div class="row g-3">
                  <div class="col-md-3">
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>Trạng thái</mat-label>
                      <mat-select [(ngModel)]="selectedStatus">
                        <mat-option *ngFor="let option of statusOptions" [value]="option.value">
                          {{ option.label }}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>
                  </div>
                  
                  <div class="col-md-3">
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>Từ ngày</mat-label>
                      <input matInput [matDatepicker]="startPicker" [(ngModel)]="createdAtStart" [max]="createdAtEnd">
                      <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                      <mat-datepicker #startPicker></mat-datepicker>
                      <mat-hint *ngIf="createdAtEnd">Phải trước hoặc bằng đến ngày</mat-hint>
                    </mat-form-field>
                  </div>
                  
                  <div class="col-md-3">
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>Đến ngày</mat-label>
                      <input matInput [matDatepicker]="endPicker" [(ngModel)]="createdAtEnd" [min]="createdAtStart">
                      <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                      <mat-datepicker #endPicker></mat-datepicker>
                      <mat-hint *ngIf="createdAtStart">Phải sau hoặc bằng từ ngày</mat-hint>
                    </mat-form-field>
                  </div>
                  
                  <div class="col-md-3">
                    <button mat-raised-button color="primary" (click)="applyFilter()" class="me-2">
                      <mat-icon>filter_list</mat-icon> Lọc
                    </button>
                    <button mat-stroked-button (click)="clearFilter()">
                      <mat-icon>clear</mat-icon> Xóa lọc
                    </button>
                  </div>
                </div>
              </div>

              <!-- Table -->
              <div class="table-container">
                <div *ngIf="isLoading" class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                  </div>
                </div>

                <table *ngIf="!isLoading" class="table table-striped table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th style="width: 50px;">STT</th>
                      <th>Mã gói</th>
                      <th>Tên dự án</th>
                      <th>Ngày bắt đầu</th>
                      <th>Ngày hết hạn</th>
                      <th>Số tiền thanh toán</th>
                      <th>Ngày thanh toán</th>
                      <th style="width: 120px;">Trạng thái</th>
                      <th style="width: 100px;">Hành động</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let sub of subscriptions; let i = index">
                      <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>
                      <td><code>{{ sub.subscriptionCode }}</code></td>
                      <td>{{ getProjectName(sub.projectId) }}</td>
                      <td>{{ calculateStartDate(sub) | date:'dd/MM/yyyy' }}</td>
                      <td>{{ sub.expiredAt | date:'dd/MM/yyyy' }}</td>
                      <td>{{ sub.amountPaid ? (sub.amountPaid | number) + ' VND' : '-' }}</td>
                      <td>{{ sub.paymentDate ? (sub.paymentDate | date:'dd/MM/yyyy') : '-' }}</td>
                      <td>
                        <span [class]="'badge ' + getStatusClass(sub.status)">
                          {{ getStatusLabel(sub.status) }}
                        </span>
                      </td>
                      <td>
                        <button mat-icon-button color="primary" (click)="openViewModal(sub)" title="Xem">
                          <mat-icon>visibility</mat-icon>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>

                <!-- Empty State -->
                <div *ngIf="!isLoading && subscriptions.length === 0" class="empty-state">
                  <mat-icon class="empty-icon">inbox</mat-icon>
                  <p class="empty-text">Không tìm thấy kết quả phù hợp.</p>
                </div>
              </div>

              <!-- Pagination -->
              <div *ngIf="!isLoading && subscriptions.length > 0" class="pagination-container">
                <div class="pagination-info">
                  Hiển thị {{ (currentPage - 1) * pageSize + 1 }} đến {{ Math.min(currentPage * pageSize, totalCount) }} trong {{ totalCount }} gói
                </div>
                <div class="pagination-controls">
                  <select class="form-select me-3" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
                    <option value="5">5 / trang</option>
                    <option value="10">10 / trang</option>
                    <option value="20">20 / trang</option>
                    <option value="50">50 / trang</option>
                  </select>
                  <nav>
                    <ul class="pagination pagination-sm mb-0">
                      <li class="page-item" [class.disabled]="currentPage === 1">
                        <button class="page-link" (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">
                          <mat-icon>chevron_left</mat-icon>
                        </button>
                      </li>
                      <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
                        <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
                      </li>
                      <li class="page-item" [class.disabled]="currentPage === totalPages">
                        <button class="page-link" (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">
                          <mat-icon>chevron_right</mat-icon>
                        </button>
                      </li>
                    </ul>
                  </nav>
                </div>
              </div>
            </mat-tab>

            <!-- Draft Tab -->
            <mat-tab label="Danh sách Nháp">
              <!-- Filter Section (Same as Main) -->
              <div class="filter-section">
                <div class="row g-3">
                  <div class="col-md-4">
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>Từ ngày</mat-label>
                      <input matInput [matDatepicker]="startPicker2" [(ngModel)]="createdAtStart" [max]="createdAtEnd">
                      <mat-datepicker-toggle matSuffix [for]="startPicker2"></mat-datepicker-toggle>
                      <mat-datepicker #startPicker2></mat-datepicker>
                      <mat-hint *ngIf="createdAtEnd">Phải trước hoặc bằng đến ngày</mat-hint>
                    </mat-form-field>
                  </div>
                  
                  <div class="col-md-4">
                    <mat-form-field appearance="outline" class="w-100">
                      <mat-label>Đến ngày</mat-label>
                      <input matInput [matDatepicker]="endPicker2" [(ngModel)]="createdAtEnd" [min]="createdAtStart">
                      <mat-datepicker-toggle matSuffix [for]="endPicker2"></mat-datepicker-toggle>
                      <mat-datepicker #endPicker2></mat-datepicker>
                      <mat-hint *ngIf="createdAtStart">Phải sau hoặc bằng từ ngày</mat-hint>
                    </mat-form-field>
                  </div>
                  
                  <div class="col-md-4">
                    <button mat-raised-button color="primary" (click)="applyFilter()" class="me-2">
                      <mat-icon>filter_list</mat-icon> Lọc
                    </button>
                    <button mat-stroked-button (click)="clearFilter()">
                      <mat-icon>clear</mat-icon> Xóa lọc
                    </button>
                  </div>
                </div>
              </div>

              <!-- Table -->
              <div class="table-container">
                <div *ngIf="isLoading" class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                  </div>
                </div>

                <table *ngIf="!isLoading" class="table table-striped table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th style="width: 50px;">STT</th>
                      <th>Mã gói</th>
                      <th>Tên dự án</th>
                      <th>Số tháng</th>
                      <th>Giá gốc</th>
                      <th>Số tiền thanh toán</th>
                      <th>Ngày tạo</th>
                      <th style="width: 120px;">Trạng thái</th>
                      <th style="width: 120px;">Hành động</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let sub of subscriptions; let i = index">
                      <td>{{ (currentPage - 1) * pageSize + i + 1 }}</td>
                      <td><code>{{ sub.subscriptionCode }}</code></td>
                      <td>{{ getProjectName(sub.projectId) }}</td>
                      <td class="text-center">{{ sub.numMonths }} tháng</td>
                      <td>{{ sub.amount | number }} VND</td>
                      <td>{{ sub.amountPaid ? (sub.amountPaid | number) + ' VND' : '-' }}</td>
                      <td>{{ sub.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
                      <td>
                        <span [class]="'badge ' + getStatusClass(sub.status)">
                          {{ getStatusLabel(sub.status) }}
                        </span>
                      </td>
                      <td>
                        <button mat-icon-button color="primary" (click)="openEditModal(sub)" title="Sửa">
                          <mat-icon>edit</mat-icon>
                        </button>
                        <button mat-icon-button color="warn" (click)="openDeleteDialog(sub)" title="Xóa">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>

                <!-- Empty State -->
                <div *ngIf="!isLoading && subscriptions.length === 0" class="empty-state">
                  <mat-icon class="empty-icon">inbox</mat-icon>
                  <p class="empty-text">Không tìm thấy kết quả phù hợp.</p>
                  <button mat-raised-button color="primary" (click)="openCreateModal()">
                    <mat-icon>add</mat-icon> Tạo gói dịch vụ đầu tiên
                  </button>
                </div>
              </div>

              <!-- Pagination -->
              <div *ngIf="!isLoading && subscriptions.length > 0" class="pagination-container">
                <div class="pagination-info">
                  Hiển thị {{ (currentPage - 1) * pageSize + 1 }} đến {{ Math.min(currentPage * pageSize, totalCount) }} trong {{ totalCount }} gói
                </div>
                <div class="pagination-controls">
                  <select class="form-select me-3" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
                    <option value="5">5 / trang</option>
                    <option value="10">10 / trang</option>
                    <option value="20">20 / trang</option>
                    <option value="50">50 / trang</option>
                  </select>
                  <nav>
                    <ul class="pagination pagination-sm mb-0">
                      <li class="page-item" [class.disabled]="currentPage === 1">
                        <button class="page-link" (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">
                          <mat-icon>chevron_left</mat-icon>
                        </button>
                      </li>
                      <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
                        <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
                      </li>
                      <li class="page-item" [class.disabled]="currentPage === totalPages">
                        <button class="page-link" (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">
                          <mat-icon>chevron_right</mat-icon>
                        </button>
                      </li>
                    </ul>
                  </nav>
                </div>
              </div>
            </mat-tab>
          </mat-tab-group>
        </div>
      </div>
    </div>
  </div>
</div>
