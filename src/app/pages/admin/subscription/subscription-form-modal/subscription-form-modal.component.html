<div mat-dialog-title>
  <h2 class="dialog-title" tabindex="-1" cdkFocusInitial style="outline: none;">{{ getTitle() }}</h2>
  <p class="dialog-subtitle text-muted small">Nhập thông tin gói dịch vụ và thanh toán</p>
</div>

<mat-dialog-content>
  <form [formGroup]="subscriptionForm" class="subscription-form">
    <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">Thông tin gói</h5>
    <!-- Project Dropdown -->
    <div class="mb-3">
      <label class="form-label fw-bold">Dự án <span class="text-danger">*</span></label>
      
      <div class="select2-wrapper" [class.disabled]="mode === 'edit' || mode === 'view'">
        <input type="text" 
               class="form-control select2-input" 
               placeholder="Nhập mã hoặc tên dự án để tìm kiếm..."
               [formControl]="projectSearchControl" 
               [matAutocomplete]="auto"
               [readonly]="mode === 'edit' || mode === 'view'">
        
        <mat-icon class="select2-arrow">arrow_drop_down</mat-icon>

        <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayProjectFn" (optionSelected)="onProjectSelected($event)">
          <mat-option *ngIf="(filteredProjects$ | async)?.length === 0" disabled>
            <span class="text-muted small">Không tìm thấy dự án nào</span>
          </mat-option>

          <mat-optgroup label="Hoạt động">
            <ng-container *ngFor="let project of (filteredProjects$ | async)">
              <mat-option *ngIf="project.isActive" [value]="project">
                <span class="fw-medium">{{ project.projectCode }}</span> - {{ project.name }}
              </mat-option>
            </ng-container>
          </mat-optgroup>

          <mat-optgroup label="Không hoạt động">
             <ng-container *ngFor="let project of (filteredProjects$ | async)">
              <mat-option *ngIf="!project.isActive" [value]="project" class="text-muted">
                <span class="fw-medium">{{ project.projectCode }}</span> - {{ project.name }} (Đã khóa)
              </mat-option>
            </ng-container>
          </mat-optgroup>
        </mat-autocomplete>
      </div>

      <div *ngIf="isFieldInvalid('projectId')" class="text-danger small mt-1">
        {{ getErrorMessage('projectId') }}
      </div>
      <div *ngIf="mode === 'edit'" class="form-text text-muted small">Không thể thay đổi dự án khi chỉnh sửa</div>
    </div>

    <!-- Subscription Code -->
    <div class="mb-3">
      <label class="form-label">Mã gói <span class="text-danger">*</span></label>
      <input type="text" class="form-control" formControlName="subscriptionCode" placeholder="VD: SUB001">
      <div *ngIf="mode === 'create'" class="form-text text-muted small">Mã tự động tạo khi chọn/đổi dự án. Bạn có thể sửa lại nếu muốn.</div>
      <div *ngIf="isFieldInvalid('subscriptionCode')" class="text-danger small mt-1">
        {{ getErrorMessage('subscriptionCode') }}
      </div>
    </div>

    <div class="row">
      <!-- Number of Months -->
      <div class="col-md-6 mb-3">
        <label class="form-label">Số tháng <span class="text-danger">*</span></label>
        <input type="number" class="form-control" formControlName="numMonths" min="1" placeholder="1">
        <div *ngIf="isFieldInvalid('numMonths')" class="text-danger small mt-1">
          {{ getErrorMessage('numMonths') }}
        </div>
      </div>

      <!-- Amount -->
      <div class="col-md-6 mb-3">
        <label class="form-label">Giá gốc gói (VNĐ) <span class="text-danger">*</span></label>
        <input type="number" class="form-control" formControlName="amount" min="0" placeholder="0">
        <div *ngIf="isFieldInvalid('amount')" class="text-danger small mt-1">
          {{ getErrorMessage('amount') }}
        </div>
      </div>
    </div>

    <!-- Payment Information Section -->
    <div>
      <h5 class="mb-3 mt-4 text-primary border-bottom pb-2">Thông tin thanh toán</h5>
      <p class="text-muted small">Các thông tin này bắt buộc khi Lưu & Duyệt</p>

      <div class="row">
        <!-- Amount Paid -->
        <div class="col-md-6 mb-3">
          <label class="form-label">Số tiền đã thanh toán (VNĐ) <span class="text-danger">*</span></label>
          <input type="number" class="form-control" formControlName="amountPaid" min="0" placeholder="0">
          <div *ngIf="isFieldInvalid('amountPaid')" class="text-danger small mt-1">
            {{ getErrorMessage('amountPaid') }}
          </div>
        </div>

        <!-- Payment Date -->
        <div class="col-md-6 mb-3">
          <label class="form-label">Ngày thanh toán <span class="text-danger">*</span></label>
          <input type="date" class="form-control" formControlName="paymentDate">
          <div *ngIf="isFieldInvalid('paymentDate')" class="text-danger small mt-1">
            {{ getErrorMessage('paymentDate') }}
          </div>
        </div>
      </div>

      <!-- Payment Method -->
      <div class="mb-3">
        <label class="form-label">Phương thức thanh toán <span class="text-danger">*</span></label>
        <select class="form-control" formControlName="paymentMethod">
          <option [ngValue]="''">Chọn phương thức</option>
          <option *ngFor="let method of paymentMethodOptions" [ngValue]="method.value">
            {{ method.label }}
          </option>
        </select>
        <div *ngIf="isFieldInvalid('paymentMethod')" class="text-danger small mt-1">
          {{ getErrorMessage('paymentMethod') }}
        </div>
      </div>

      <!-- Payment Note -->
      <div class="mb-3">
        <label class="form-label">Ghi chú thanh toán</label>
        <textarea class="form-control" formControlName="paymentNote" rows="3" placeholder="Nhập ghi chú (nếu có)"></textarea>
      </div>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end" class="d-flex justify-content-end gap-2 mt-3 pt-3 border-top">
  <button type="button" class="btn btn-secondary" (click)="onCancel()" [disabled]="isSubmitting">Hủy</button>

  <ng-container *ngIf="mode !== 'view'">
    <button type="button" class="btn btn-outline-primary" (click)="onSaveDraft()" [disabled]="isSubmitting">Lưu Nháp</button>
    <button type="button" class="btn btn-primary" (click)="onSaveAndApprove()" [disabled]="isSubmitting">
      {{ isSubmitting ? 'Đang xử lý...' : 'Lưu & Duyệt' }}
    </button>
  </ng-container>
</mat-dialog-actions>

