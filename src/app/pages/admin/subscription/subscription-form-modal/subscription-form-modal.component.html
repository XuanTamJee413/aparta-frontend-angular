<h2 mat-dialog-title>{{ getTitle() }}</h2>

<mat-dialog-content>
  <form [formGroup]="subscriptionForm" class="subscription-form">
    <!-- Project Dropdown -->
    <mat-form-field appearance="outline" class="w-100">
      <mat-label>Dự án *</mat-label>
      <mat-select formControlName="projectId">
        <mat-option *ngFor="let project of projects" [value]="project.projectId">
          {{ project.projectCode }} - {{ project.name }}
        </mat-option>
      </mat-select>
      <mat-icon matSuffix>business</mat-icon>
      <mat-error *ngIf="isFieldInvalid('projectId')">
        {{ getErrorMessage('projectId') }}
      </mat-error>
      <mat-hint *ngIf="mode === 'edit'">Không thể thay đổi dự án khi chỉnh sửa</mat-hint>
    </mat-form-field>

    <!-- Subscription Code -->
    <mat-form-field appearance="outline" class="w-100">
      <mat-label>Mã gói *</mat-label>
      <input matInput formControlName="subscriptionCode" placeholder="VD: SUB001">
      <mat-icon matSuffix>confirmation_number</mat-icon>
      <mat-hint *ngIf="mode === 'create'">Mã tự động tạo khi chọn/đổi dự án. Bạn có thể sửa lại nếu muốn.</mat-hint>
      <mat-error *ngIf="isFieldInvalid('subscriptionCode')">
        {{ getErrorMessage('subscriptionCode') }}
      </mat-error>
    </mat-form-field>

    <div class="row g-3">
      <!-- Number of Months -->
      <div class="col-md-6">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Số tháng *</mat-label>
          <input matInput type="number" formControlName="numMonths" min="1" placeholder="1">
          <mat-icon matSuffix>calendar_today</mat-icon>
          <mat-error *ngIf="isFieldInvalid('numMonths')">
            {{ getErrorMessage('numMonths') }}
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Amount -->
      <div class="col-md-6">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Giá gốc gói (VNĐ) *</mat-label>
          <input matInput type="number" formControlName="amount" min="0" placeholder="0">
          <mat-icon matSuffix>attach_money</mat-icon>
          <mat-error *ngIf="isFieldInvalid('amount')">
            {{ getErrorMessage('amount') }}
          </mat-error>
        </mat-form-field>
      </div>
    </div>

    <!-- Payment Information Section -->
    <div class="payment-section">
      <h4 class="section-title">Thông tin thanh toán</h4>
      <p class="section-subtitle">Các thông tin này bắt buộc khi "Lưu & Duyệt"</p>

      <div class="row g-3">
        <!-- Amount Paid -->
        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Số tiền đã thanh toán (VNĐ)</mat-label>
            <input matInput type="number" formControlName="amountPaid" min="0" placeholder="0">
            <mat-icon matSuffix>payment</mat-icon>
            <mat-error *ngIf="isFieldInvalid('amountPaid')">
              {{ getErrorMessage('amountPaid') }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Payment Date -->
        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Ngày thanh toán</mat-label>
            <input matInput [matDatepicker]="paymentPicker" formControlName="paymentDate">
            <mat-datepicker-toggle matSuffix [for]="paymentPicker"></mat-datepicker-toggle>
            <mat-datepicker #paymentPicker></mat-datepicker>
            <mat-error *ngIf="isFieldInvalid('paymentDate')">
              {{ getErrorMessage('paymentDate') }}
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Payment Method -->
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Phương thức thanh toán</mat-label>
        <mat-select formControlName="paymentMethod">
          <mat-option *ngFor="let method of paymentMethodOptions" [value]="method.value">
            {{ method.label }}
          </mat-option>
        </mat-select>
        <mat-icon matSuffix>account_balance_wallet</mat-icon>
        <mat-error *ngIf="isFieldInvalid('paymentMethod')">
          {{ getErrorMessage('paymentMethod') }}
        </mat-error>
      </mat-form-field>

      <!-- Payment Note -->
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Ghi chú thanh toán</mat-label>
        <textarea matInput formControlName="paymentNote" rows="3" placeholder="Nhập ghi chú (nếu có)"></textarea>
        <mat-icon matSuffix>note</mat-icon>
      </mat-form-field>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()" [disabled]="isSubmitting">
    <mat-icon>close</mat-icon> Hủy
  </button>

  <div *ngIf="mode !== 'view'">
    <button mat-stroked-button color="primary" (click)="onSaveDraft()" [disabled]="isSubmitting">
      <mat-icon>save</mat-icon> Lưu Nháp
    </button>
    
    <button mat-raised-button color="primary" (click)="onSaveAndApprove()" [disabled]="isSubmitting">
      <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
      <mat-icon *ngIf="!isSubmitting">check_circle</mat-icon>
      {{ isSubmitting ? 'Đang xử lý...' : 'Lưu & Duyệt' }}
    </button>
  </div>
</mat-dialog-actions>

