<div class="container">
  <div class="card">
    <header>
      <div class="header-row">
        <div>
          <h1>Chỉnh sửa Manager</h1>
          <p>Cập nhật thông tin quản lý viên</p>
        </div>
        <a routerLink="/admin/manager/list" class="btn-secondary">
          <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Quay lại
        </a>
      </div>
    </header>

    <div *ngIf="errorMessage" class="alert-error">
      <strong>Lỗi!</strong> {{ errorMessage }}
      <button class="alert-close" (click)="errorMessage = ''">×</button>
    </div>

    <div *ngIf="loading" class="loading-container">
      <div class="spinner"></div>
      <p>Đang tải dữ liệu...</p>
    </div>

    <form *ngIf="!loading && currentManager" (ngSubmit)="onSubmit(managerForm)" #managerForm="ngForm" class="manager-form">
      <section class="profile-panel">
        <div class="profile-panel__avatar">
          <img
            [src]="currentAvatarUrl || defaultAvatarUrl"
            alt="Ảnh đại diện"
            class="avatar-image" />
          <div class="upload-controls">
            <button
              type="button"
              class="upload-btn"
              (click)="avatarInput.click()"
              [disabled]="uploadingAvatar || submitting">
              <span *ngIf="!uploadingAvatar">Đổi ảnh</span>
              <span *ngIf="uploadingAvatar" class="upload-btn-loading">
                <span class="upload-spinner"></span> Đang tải...
              </span>
            </button>
          </div>
          <div class="upload-status" *ngIf="uploadingAvatar">
            <div class="upload-spinner"></div>
            <span>Đang tải ảnh...</span>
          </div>
          <p *ngIf="avatarUploadError" class="error-message">{{ avatarUploadError }}</p>
          <input
            #avatarInput
            type="file"
            accept="image/*"
            hidden
            (change)="onFileSelected($event); avatarInput.value='';" />
        </div>
        <div class="profile-panel__meta">
          <div class="meta-chip"
            [ngClass]="{
              'status-active': manager.status?.toLowerCase() === 'active',
              'status-inactive': manager.status?.toLowerCase() !== 'active'
            }">
            {{ manager.status || 'Chưa thiết lập' }}
          </div>
          <div class="meta-grid">
            <div class="meta-card">
              <span class="meta-label">Last login</span>
              <strong>{{ currentManager.lastLoginAt || 'Chưa đăng nhập' }}</strong>
            </div>
            <div class="meta-card">
              <span class="meta-label">Email</span>
              <strong>{{ manager.email || 'Chưa có' }}</strong>
            </div>
            <div class="meta-card">
              <span class="meta-label">Building đang phụ trách</span>
              <strong>{{ manager.buildingIds.length }}</strong>
            </div>
          </div>
        </div>
      </section>

      <section class="form-section">
        <div class="section-header">
          <div>
            <h2>Thông tin cơ bản</h2>
            <p>Cập nhật thông tin nhận diện và liên hệ của quản lý.</p>
          </div>
        </div>
        <div class="section-grid">
          <div class="form-group">
            <label class="form-label" for="name">Họ tên <span class="required">*</span></label>
            <input
              type="text"
              id="name"
              name="name"
              class="form-input"
              [(ngModel)]="manager.name"
              #nameCtrl="ngModel"
              required
              placeholder="Nhập họ tên đầy đủ..."
              [disabled]="submitting"
              [ngClass]="{'input-error': nameCtrl.invalid && (nameCtrl.touched || managerForm.submitted)}" />
            <p class="error-message" *ngIf="nameCtrl.invalid && (nameCtrl.touched || managerForm.submitted)">
              Họ tên không được bỏ trống.
            </p>
          </div>
          <div class="form-group">
            <label class="form-label" for="staffCode">Mã nhân viên <span class="required">*</span></label>
            <input
              type="text"
              id="staffCode"
              name="staffCode"
              class="form-input"
              [ngModel]="manager.staffCode"
              (ngModelChange)="onStaffCodeChange($event)"
              #staffCodeCtrl="ngModel"
              required
              placeholder="VD: MGR001"
              [disabled]="submitting"
              pattern="^[A-Z0-9]{5}$"
              maxlength="5"
              [ngClass]="{'input-error': staffCodeCtrl.invalid && (staffCodeCtrl.touched || managerForm.submitted)}" />
            <p class="error-message" *ngIf="staffCodeCtrl.invalid && (staffCodeCtrl.touched || managerForm.submitted)">
              <span *ngIf="staffCodeCtrl.errors?.['required']">Mã nhân viên là bắt buộc.</span>
              <span *ngIf="staffCodeCtrl.errors?.['pattern']">Mã nhân viên phải gồm đúng 5 ký tự chữ in hoa và số.</span>
            </p>
          </div>
          <div class="form-group">
            <label class="form-label" for="email">Email <span class="required">*</span></label>
            <input
              type="email"
              id="email"
              name="email"
              class="form-input"
              [(ngModel)]="manager.email"
              #emailCtrl="ngModel"
              required
              email
              placeholder="manager@example.com"
              [disabled]="submitting"
              [ngClass]="{'input-error': emailCtrl.invalid && (emailCtrl.touched || managerForm.submitted)}" />
            <p class="error-message" *ngIf="emailCtrl.invalid && (emailCtrl.touched || managerForm.submitted)">
              Nhập email hợp lệ.
            </p>
          </div>
          <div class="form-group">
            <label class="form-label" for="phone">Số điện thoại <span class="required">*</span></label>
            <input
              type="tel"
              id="phone"
              name="phone"
              class="form-input"
              [ngModel]="manager.phone"
              (ngModelChange)="onPhoneInput($event)"
              #phoneCtrl="ngModel"
              required
              inputmode="numeric"
              autocomplete="tel"
              pattern="^[0-9]{10}$"
              maxlength="10"
              placeholder="0987654321"
              [disabled]="submitting"
              [ngClass]="{'input-error': phoneCtrl.invalid && (phoneCtrl.touched || managerForm.submitted)}" />
            <p class="error-message" *ngIf="phoneCtrl.invalid && (phoneCtrl.touched || managerForm.submitted)">
              <span *ngIf="phoneCtrl.errors?.['required']">Số điện thoại là bắt buộc.</span>
              <span *ngIf="phoneCtrl.errors?.['pattern']">Số điện thoại phải có đúng 10 chữ số.</span>
            </p>
          </div>
        </div>
      </section>

      <section class="form-section">
        <div class="section-header">
          <div>
            <h2>Cài đặt tài khoản</h2>
            <p>Quản lý trạng thái hoạt động và bảo mật.</p>
          </div>
        </div>
        <div class="section-grid">
          <div class="form-group">
            <label class="form-label" for="password">Mật khẩu mới (để trống nếu không đổi)</label>
            <input
              type="password"
              id="password"
              name="password"
              class="form-input"
              [(ngModel)]="manager.password"
              #passwordCtrl="ngModel"
              minlength="6"
              placeholder="Tối thiểu 6 ký tự"
              [disabled]="submitting"
              [ngClass]="{'input-error': passwordCtrl.invalid && (passwordCtrl.touched || managerForm.submitted)}" />
            <p class="error-message" *ngIf="passwordCtrl.invalid && (passwordCtrl.touched || managerForm.submitted)">
              Mật khẩu tối thiểu 6 ký tự.
            </p>
          </div>
          <div class="form-group">
            <label class="form-label" for="status">Trạng thái <span class="required">*</span></label>
            <select id="status" name="status" class="form-input" [(ngModel)]="manager.status" required [disabled]="submitting">
              <option value="">-- Chọn trạng thái --</option>
              <option *ngFor="let option of statusOptions" [value]="option.value">
                {{ option.label }}
              </option>
            </select>
          </div>
        </div>
      </section>

      <section class="form-section">
        <div class="section-header">
          <div>
            <h2>Toà nhà phụ trách</h2>
            <p>Tick chọn để gán quyền quản lý cho từng toà nhà.</p>
          </div>
        </div>
        <div class="building-grid" *ngIf="(allBuildings$ | async) as buildings">
          <label
            class="building-item"
            *ngFor="let building of buildings"
            [for]="'edit-building-' + building.buildingId">
            <input 
              type="checkbox"
              [id]="'edit-building-' + building.buildingId"
              [value]="building.buildingId"
              [checked]="manager.buildingIds.includes(building.buildingId)"
              (change)="onBuildingChange($event)"
              [disabled]="submitting">
            <div>
              <strong>{{ building.name }}</strong>
              <p>{{ building.buildingCode }}</p>
            </div>
          </label>
          <div *ngIf="buildings.length === 0" class="building-empty">
            Không có building nào để gán.
          </div>
        </div>
      </section>

      <div class="form-actions">
        <button type="button" class="btn-primary" [disabled]="submitting || uploadingAvatar" (click)="onSubmit(managerForm)">
          <svg *ngIf="!submitting" class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          <div *ngIf="submitting" class="btn-spinner"></div>
          {{ submitting ? 'Đang cập nhật...' : 'Cập nhật Manager' }}
        </button>
        <a routerLink="/admin/manager/list" class="btn-cancel" [class.disabled]="submitting">Hủy</a>
      </div>
    </form>

  </div>
</div>
