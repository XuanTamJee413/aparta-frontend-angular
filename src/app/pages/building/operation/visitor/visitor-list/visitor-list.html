<app-fast-checkin 
  *ngIf="showFastCheckin"
  (checkinSuccess)="onFastCheckinSuccess($event)"
  (closeForm)="onFastCheckinClose()">
</app-fast-checkin>

<div *ngIf="!showFastCheckin">
  <div class="card shadow-sm border-0 container">

    <div class="card-header bg-light border-bottom p-3">
      <div class="row align-items-center g-3">

        <div class="col-md-4">
          <h4 class="card-title mb-1">Quản lý khách thăm</h4>
          <small class="text-muted">Danh sách tất cả khách thăm đã đăng ký</small>
        </div>

        <div class="col-md-8">
          <div class="row g-2 align-items-center justify-content-md-end">
            
            <div class="col-sm-6 col-md-auto">
              <div class="input-group input-group-sm">
                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                <input type="search" class="form-control" placeholder="Tìm kiếm khách thăm...">
              </div>
            </div>
            
            <div class="col-sm-6 col-md-auto">
              <select class="form-select form-select-sm" style="min-width: 150px;">
                <option value="">Tất cả căn hộ</option>
                <option *ngFor="let apt of apartmentList" [value]="apt.apartmentId">
                  {{apt.apartmentCode}}
                </option>
              </select>
            </div>

            <div class="col-12 col-md-auto">
              <button type="button" class="btn btn-sm btn-primary w-100" (click)="showFastCheckin = true">
                <i class="bi bi-person-plus-fill me-1"></i> Check-in nhanh
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>
    
    <div class="card-body">

      <div *ngIf="isLoading" class="d-flex justify-content-center align-items-center m-5 p-5">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <div *ngIf="!isLoading && allVisitors.length === 0" class="text-center text-muted m-5 p-5">
        <span><i class="bi bi-cloud-drizzle fs-1"></i></span>
        <h5 class="mt-2">Chưa có dữ liệu</h5>
        <p>Hiện không có khách thăm nào trong hệ thống.</p>
      </div>

      <div *ngIf="!isLoading && allVisitors.length > 0" class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th scope="col" class="small text-uppercase text-muted fw-semibold">Tên khách</th>
              <th scope="col" class="small text-uppercase text-muted fw-semibold">Thời gian Vào / Ra</th>
              <th scope="col" class="small text-uppercase text-muted fw-semibold">Trạng thái</th>
              <th scope="col" class="text-end small text-uppercase text-muted fw-semibold">Hành động</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let log of allVisitors">
              <td>
                <button type="button" class="btn btn-link p-0 text-start" (click)="openVisitorDetails(log)">
                  <div class="fw-bold">{{log.visitorFullName}}</div>
                  <small class="text-muted">{{log.visitorIdNumber || 'N/A'}}</small>
                </button>
              </td>

              <td>
                <div class="time-cell">
                  <div *ngIf="log.status === 'Pending'" class="d-flex align-items-center">
                    <i class="bi bi-clock-history me-2 text-warning"></i>
                    <strong>{{log.checkinTime | date: 'HH:mm dd/MM/yy'}}</strong>
                    <span class="text-muted small ms-1">(Dự kiến)</span>
                  </div>
                  <div *ngIf="log.status !== 'Pending' && log.status !== 'Cancelled'" class="d-flex align-items-center">
                    <i class="bi bi-box-arrow-in-right me-2 text-success"></i>
                    <strong>{{log.checkinTime | date: 'HH:mm dd/MM/yy'}}</strong>
                    <span class="text-muted small ms-1">(Thực tế)</span>
                  </div>
                  <div *ngIf="log.status === 'Cancelled'" class="time-cell">
                    <span class="text-danger small">(Đã hủy)</span>
                  </div>
                </div>
                <div class="time-cell mt-1">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-box-arrow-right me-2 text-secondary"></i>
                    <span>{{log.checkoutTime ? (log.checkoutTime | date: 'HH:mm dd/MM/yy') : 'N/A'}}</span>
                  </div>
                </div>
              </td>

              <td>
                <span class="badge rounded-pill" [ngClass]="getStatusBadge(log.status)">
                  {{log.status}}
                </span>
              </td>

              <td class="text-end action-cell">
                <button type="button" class="btn btn-sm btn-outline-success" title="Check-in cho khách"
                  (click)="onCheckIn(log)"
                  [disabled]="log.status === 'Checked-in' || log.status === 'Checked-out' || log.status === 'Cancelled'">
                  Check-in
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger ms-2" title="Check-out cho khách"
                  (click)="onCheckOut(log)" [disabled]="log.status !== 'Checked-in'">
                  Check-out
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<div *ngIf="alertMessage" class="alert alert-dismissible fade show shadow-lg position-fixed bottom-0 end-0 p-3 m-3"
  [ngClass]="alertType === 'success' ? 'alert-success' : 'alert-danger'" style="z-index: 1080; min-width: 300px;"
  role="alert">
  <i class="bi me-2" [ngClass]="alertType === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill'"></i>
  {{ alertMessage }}
  <button type="button" class="btn-close" (click)="alertMessage = null" aria-label="Close"></button>
</div>

<div *ngIf="isModalVisible" class="modal-backdrop fade show"></div>
<div *ngIf="isModalVisible" class="modal fade show d-block" tabindex="-1" role="dialog" (click)="closeVisitorDetails()">
  <div class="modal-dialog modal-dialog-centered modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-content shadow">

      <div class="modal-header">
        <h5 class="modal-title" id="visitorDetailsModalLabel">
          Chi tiết khách thăm: {{selectedVisitor?.visitorFullName}}
        </h5>
        <button type="button" class="btn-close" (click)="closeVisitorDetails()" aria-label="Close"></button>
      </div>
      <div class="modal-body" *ngIf="selectedVisitor">
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span class="text-muted">Visit Log ID</span>
            <strong class="text-dark">{{selectedVisitor.visitLogId}}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span class="text-muted">Họ và tên</span>
            <strong class="text-dark">{{selectedVisitor.visitorFullName}}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span class="text-muted">CCCD/Số ID</span>
            <strong class="text-dark">{{selectedVisitor.visitorIdNumber || 'N/A'}}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span class="text-muted">Căn hộ</span>
            <strong class="text-primary fw-bold">{{selectedVisitor.apartmentCode}}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span class="text-muted">Trạng thái</span>
            <span class="badge rounded-pill" [ngClass]="getStatusBadge(selectedVisitor.status)">
              {{selectedVisitor.status}}
            </span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span class="text-muted">Thời gian Check-in</span>
            <strong class="text-dark">{{selectedVisitor.checkinTime | date: 'HH:mm:ss dd/MM/yyyy'}}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span class="text-muted">Thời gian Check-out</span>
            <strong class="text-dark">{{selectedVisitor.checkoutTime ? (selectedVisitor.checkoutTime | date: 'HH:mm:ss
              dd/MM/yyyy') : 'Chưa check-out'}}</strong>
          </li>
          <li class="list-group-item">
            <div class="text-muted mb-1">Mục đích</div>
            <textarea class="form-control-plaintext" rows="2"
              readonly>{{selectedVisitor.purpose || 'Không có mục đích cụ thể'}}</textarea>
          </li>
        </ul>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeVisitorDetails()">Đóng</button>
      </div>
    </div>
  </div>
</div>