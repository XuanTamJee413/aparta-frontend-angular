<app-fast-checkin *ngIf="showFastCheckin" (checkinSuccess)="onFastCheckinSuccess($event)"
  (closeForm)="onFastCheckinClose()">
</app-fast-checkin>

<div class="visitor-container" *ngIf="!showFastCheckin">

  <mat-card class="main-card mat-elevation-z2">
    <mat-card-header>
      <mat-card-title>Quản lý khách thăm</mat-card-title>
      <mat-card-subtitle>Danh sách tất cả khách thăm đã đăng ký</mat-card-subtitle>

      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="showFastCheckin = true">
          <mat-icon>person_add</mat-icon> Check-in nhanh
        </button>
      </div>
    </mat-card-header>

    <mat-divider></mat-divider>

    <mat-card-content>
      <div class="filter-row">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Tìm tên hoặc căn hộ...</mat-label>
          <mat-icon matPrefix>search</mat-icon>
          <input matInput [ngModel]="queryParams.searchTerm" (input)="onSearchInput($event)">
        </mat-form-field>

        <mat-form-field appearance="outline" class="select-field">
          <mat-label>Căn hộ</mat-label>
          <mat-select [ngModel]="queryParams.apartmentId" (selectionChange)="onApartmentFilterChange($event.value)">
            <mat-option value="">Tất cả căn hộ</mat-option>
            <mat-option *ngFor="let apt of apartmentList" [value]="apt.apartmentId">
              {{apt.code}}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="loading-shade" *ngIf="isLoading">
        <mat-spinner diameter="50"></mat-spinner>
      </div>

      <div class="empty-state" *ngIf="!isLoading && (!paginatedVisitors || paginatedVisitors.totalCount === 0)">
        <mat-icon class="large-icon">cloud_off</mat-icon>
        <h3>Chưa có dữ liệu</h3>
        <p>Không tìm thấy khách thăm nào phù hợp với tiêu chí.</p>
      </div>

      <div class="table-container" [class.hidden]="!paginatedVisitors || paginatedVisitors.totalCount === 0">
        <table mat-table [dataSource]="paginatedVisitors?.items || []" matSort (matSortChange)="onSortChange($event)"
          [matSortActive]="queryParams.sortColumn || 'checkinTime'"
          [matSortDirection]="queryParams.sortDirection === 'asc' ? 'asc' : 'desc'">

          <ng-container matColumnDef="visitorInfo">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="visitorFullName"> Khách & Căn hộ </th>
            <td mat-cell *matCellDef="let log">
              <div class="visitor-info-cell">
                <span class="visitor-name clickable-name" (click)="openVisitorDetails(log)" matTooltip="Xem chi tiết">
                  {{log.visitorFullName}}
                </span>
                <span class="apartment-code">{{log.apartmentCode}}</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="checkinTime">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="checkinTime"> Thời gian </th>
            <td mat-cell *matCellDef="let log">
              <div class="time-cell">
                <div *ngIf="log.status === 'Pending'" class="time-row pending">
                  <mat-icon class="tiny-icon">schedule</mat-icon>
                  <span>{{log.checkinTime | date: 'HH:mm dd/MM/yy'}} (Dự kiến)</span>
                </div>
                <div *ngIf="log.status !== 'Pending' && log.status !== 'Cancelled'" class="time-row active">
                  <mat-icon class="tiny-icon">login</mat-icon>
                  <span>{{log.checkinTime | date: 'HH:mm dd/MM/yy'}}</span>
                </div>
                <div class="time-row checkout" *ngIf="log.checkoutTime">
                  <mat-icon class="tiny-icon">logout</mat-icon>
                  <span>{{log.checkoutTime | date: 'HH:mm dd/MM/yy'}}</span>
                </div>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="text-end"> Hành động </th>
            <td mat-cell *matCellDef="let log" class="text-end">
              <div class="action-buttons">
                <button mat-stroked-button color="primary" (click)="openConfirmPopup('checkin', log)" [disabled]="log.status === 'Checked-in' || 
                    log.status === 'Checked-out' || 
                    log.status === 'Cancelled' || 
                    log.status === 'Rejected'">
                  <mat-icon>login</mat-icon> Check-in
                </button>

                <button mat-stroked-button color="accent" (click)="openConfirmPopup('checkout', log)"
                  [disabled]="log.status !== 'Checked-in' || log.status === 'Cancelled'">
                  <mat-icon>logout</mat-icon> Check-out
                </button>

                <button mat-stroked-button color="warn" (click)="openConfirmPopup('reject', log)"
                  [disabled]="log.status !== 'Pending' || log.status === 'Cancelled'">
                  <mat-icon>block</mat-icon> Từ chối
                </button>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef> Trạng thái </th>
            <td mat-cell *matCellDef="let log">
              <mat-chip [class]="getStatusClass(log.status)">
                {{log.status}}
              </mat-chip>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>

      <mat-paginator [length]="paginatedVisitors?.totalCount || 0" [pageSize]="queryParams.pageSize"
        [pageIndex]="queryParams.pageNumber - 1" [pageSizeOptions]="[5, 10, 25, 50]" (page)="onMatPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>

    </mat-card-content>
  </mat-card>
</div>

<div *ngIf="alertMessage" class="custom-snackbar" [ngClass]="alertType">
  <div class="snackbar-content">
    <mat-icon>{{ alertType === 'success' ? 'check_circle' : 'error' }}</mat-icon>
    <span>{{ alertMessage }}</span>
  </div>
  <button mat-icon-button (click)="alertMessage = null" class="close-btn">
    <mat-icon>close</mat-icon>
  </button>
</div>

<div class="modal-overlay" *ngIf="isModalVisible" (click)="closeVisitorDetails()">
  <div class="modal-dialog-card" (click)="$event.stopPropagation()">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Chi tiết khách thăm</mat-card-title>
        <mat-card-subtitle>{{selectedVisitor?.visitorFullName}}</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content class="modal-content-body" *ngIf="selectedVisitor">
        <div class="detail-row">
          <span class="label">Mã Log:</span>
          <span class="value">{{selectedVisitor.visitLogId}}</span>
        </div>
        <div class="detail-row">
          <span class="label">CCCD/ID:</span>
          <span class="value">{{selectedVisitor.visitorIdNumber || 'N/A'}}</span>
        </div>
        <div class="detail-row">
          <span class="label">Căn hộ:</span>
          <span class="value active">{{selectedVisitor.apartmentCode}}</span>
        </div>
        <div class="detail-row">
          <span class="label">Trạng thái:</span>
          <mat-chip-set>
            <mat-chip [class]="getStatusClass(selectedVisitor.status)">
              {{selectedVisitor.status}}
            </mat-chip>
          </mat-chip-set>
        </div>
        <mat-divider class="my-2"></mat-divider>
        <div class="detail-row">
          <span class="label">Check-in:</span>
          <span class="value">{{selectedVisitor.checkinTime | date: 'HH:mm:ss dd/MM/yyyy'}}</span>
        </div>
        <div class="detail-row">
          <span class="label">Check-out:</span>
          <span class="value">{{selectedVisitor.checkoutTime ? (selectedVisitor.checkoutTime | date: 'HH:mm:ss
            dd/MM/yyyy') : '---'}}</span>
        </div>
        <div class="detail-row mt-2">
          <span class="label">Mục đích:</span>
          <p class="purpose-text">{{selectedVisitor.purpose || 'Không có mục đích cụ thể'}}</p>
        </div>
      </mat-card-content>

      <mat-card-actions align="end">
        <button mat-button (click)="closeVisitorDetails()">Đóng</button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>
<div class="modal-overlay" *ngIf="isConfirmVisible" (click)="isConfirmVisible = false">
  <div class="confirm-card" (click)="$event.stopPropagation()">
    <mat-card>
      <mat-card-header>
        <mat-card-title>{{ confirmTitle }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p style="padding: 20px 0; font-size: 16px;">{{ confirmMessage }}</p>
      </mat-card-content>
      <mat-card-actions align="end">
        <button mat-button (click)="isConfirmVisible = false">Hủy</button>
        <button mat-raised-button [color]="confirmActionType === 'reject' ? 'warn' : 'primary'"
          (click)="executeConfirmAction()">
          Xác nhận
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>