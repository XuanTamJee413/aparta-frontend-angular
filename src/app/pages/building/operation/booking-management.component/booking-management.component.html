<div class="container">
  <div class="card">
    <header>
      <h1>Quản lý Đặt lịch Dịch vụ</h1>
      <p>Danh sách các yêu cầu đặt lịch dịch vụ từ cư dân</p>
    </header>

    <!-- Success Message - tự động biến mất sau 5 giây -->
    <div *ngIf="pageSuccessMessage" class="alert-success">
      {{ pageSuccessMessage }}
    </div>

    <div class="toolbar">
      <div class="search-wrapper">
        <div class="search-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
              clip-rule="evenodd" />
          </svg>
        </div>
        <input type="text" class="search-input" placeholder="Tìm theo tên dịch vụ..."
          [formControl]="searchControl"
          (keyup.enter)="onSearch()" />
      </div>

      <div class="filter-wrapper">
        <select class="status-select" [formControl]="statusFilterControl" (change)="onFilterChange()">
          <option *ngFor="let option of statusOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>

      <div class="actions-right">
        <!-- Có thể thêm nút refresh hoặc export sau -->
      </div>
    </div>

    <div *ngIf="isLoading" class="text-center" style="padding: 2rem;">
      <p>Đang tải dữ liệu...</p>
    </div>

    <ng-container *ngIf="!isLoading">
      <div class="table-container">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Dịch Vụ</th>
                <th>Cư Dân</th>
                <th>Ngày Hẹn</th>
                <th>Trạng Thái</th>
                <!-- <th>Ghi Chú (Cư dân)</th> -->
                <th>Chi Phí</th>
                <th>Hành Động</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="bookings.length === 0">
                <td colspan="7" class="no-results">
                  Không tìm thấy đơn đặt lịch nào.
                </td>
              </tr>

              <tr *ngFor="let booking of bookings">
                <td class="font-medium">{{ booking.serviceName }}</td>
                <td class="font-medium">{{ booking.residentName }}</td>
                <td>{{ booking.bookingDate | date:'dd/MM/yyyy HH:mm' }}</td>
                <td>
                  <span class="status-badge status-{{ booking.status | lowercase }}">
                    {{ getStatusLabel(booking.status) }}
                  </span>
                </td>
                <!-- <td>{{ booking.residentNote || '—' }}</td> -->
                <td>{{ (booking.paymentAmount || 0) | number:'1.0-0' }} VND</td>
                <td class="actions">
                  <button type="button" class="action-edit-btn" (click)="openEditModal(booking)">
                    <svg class="action-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" />
                    </svg>
                    Cập nhật
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="pagination" *ngIf="totalPages > 1">
        <span class="page-info">
          Trang <span class="font-medium">{{ currentPage }}</span> /
          <span class="font-medium">{{ totalPages }}</span>
        </span>
        <div class="pagination-buttons">
          <button class="pagination-btn" [disabled]="currentPage === 1" (click)="onPageChange(currentPage - 1)">
            Trước
          </button>
          <button class="pagination-btn" [disabled]="currentPage === totalPages" (click)="onPageChange(currentPage + 1)">
            Tiếp
          </button>
        </div>
      </div>
    </ng-container>
  </div>
</div>

<!-- Modal Cập nhật Đặt lịch -->
<dialog #bookingDialog class="service-modal" (close)="onDialogClose()">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Cập nhật Đặt lịch Dịch vụ</h3>
      <button type="button" class="modal-close" (click)="hideDialog()">×</button>
    </div>

    <form [formGroup]="bookingForm" (ngSubmit)="saveBooking()">
      <div class="modal-body">
        <div class="form-group">
          <label>Trạng thái <span class="required">*</span></label>
          <select class="form-select" formControlName="status">
            <option *ngFor="let option of dialogStatusOptions" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
          <small class="text-muted" *ngIf="bookingForm.get('status')?.value === 'Approved'">
            Khi chọn "Đã duyệt", hệ thống sẽ tự động tạo Công việc (Task) mới.
          </small>
        </div>

        <div class="form-group">
          <label>Chi phí thực tế (VND) <span class="required">*</span></label>
          <input type="number" class="form-input" formControlName="paymentAmount" min="0" step="1000" placeholder="0" />
          <small class="form-error" *ngIf="bookingForm.get('paymentAmount')?.invalid && bookingForm.get('paymentAmount')?.touched">
            Chi phí phải lớn hơn hoặc bằng 0.
          </small>
        </div>

        <div class="form-group">
          <label>Ghi chú (Nhân viên)</label>
          <textarea class="form-input" formControlName="staffNote" rows="4" placeholder="Ghi chú nội bộ, hướng dẫn thực hiện..."></textarea>
        </div>
      </div>

      <!-- Lỗi từ backend (ví dụ: Task đã tồn tại, v.v.) -->
      <div *ngIf="dialogErrorMessage" class="alert-error">
        <strong>Lỗi:</strong> {{ dialogErrorMessage }}
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-cancel" (click)="hideDialog()">Hủy</button>
        <button type="submit" class="btn-save" [disabled]="bookingForm.invalid">
          Lưu
        </button>
      </div>
    </form>
  </div>
</dialog>