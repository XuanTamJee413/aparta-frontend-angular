<div class="meter-reading-container">
  <!-- Toast Notification -->
  <div class="toast-container" *ngIf="toast.show">
    <div class="toast" [class.toast-success]="toast.type === 'success'" [class.toast-error]="toast.type === 'error'">
      <div class="toast-icon">
        <svg *ngIf="toast.type === 'success'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        <svg *ngIf="toast.type === 'error'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="toast-message">{{ toast.message }}</div>
      <button class="toast-close" (click)="hideToast()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
  </div>

  <div class="main-card">
    <div class="card-header">
      <h1 class="card-title">
        Nhập chỉ số điện nước
      </h1>
    </div>

    <div class="card-content">
      <!-- Building Selection -->
      <div class="form-section">
        <h3 class="section-title">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/>
          </svg>
          Chọn Tòa nhà
        </h3>
        <div class="form-field">
          <label class="field-label">Tòa nhà</label>
          <div class="select-wrapper">
            <select 
              class="form-select" 
              [(ngModel)]="selectedBuildingId" 
              (change)="onBuildingChange()" 
              [disabled]="loadingBuildings">
              <option value="">-- Chọn tòa nhà --</option>
              <option *ngFor="let building of buildings" [value]="building.buildingId">
                {{ building.name || building.buildingCode }}
              </option>
            </select>
            <div class="spinner-small" *ngIf="loadingBuildings"></div>
          </div>
        </div>
      </div>

      <!-- Apartment List -->
      <div class="form-section" *ngIf="selectedBuildingId && !loadingApartments">
        <h3 class="section-title">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
          </svg>
          Danh sách căn hộ đã thuê
        </h3>
        
        <!-- Search -->
        <div class="search-wrapper" style="margin-bottom: 16px;">
          <div class="search-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
            </svg>
          </div>
          <input
            type="text"
            class="search-input"
            placeholder="Tìm kiếm theo tên căn hộ..."
            [(ngModel)]="searchText"
            (ngModelChange)="onSearchChange()"
          />
        </div>

        <div class="apartment-list" *ngIf="filteredApartments.length > 0">
          <div 
            class="apartment-card" 
            *ngFor="let apartment of getPaginatedApartments()"
            [class.selected]="apartment.apartmentId === selectedApartmentId"
            (click)="onApartmentClick(apartment)">
            <div class="apartment-header">
              <svg class="apartment-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              </svg>
              <span class="apartment-code">{{ apartment.code }}</span>
            </div>
            <div class="apartment-details">
              <div class="detail-item">
                <span class="detail-label">Loại:</span>
                <span class="detail-value">{{ apartment.type }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Diện tích:</span>
                <span class="detail-value">{{ apartment.area }} m²</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Trạng thái:</span>
                <span class="detail-value status-badge">{{ apartment.status }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div *ngIf="filteredApartments.length > 0" class="pagination-container" style="margin-top: 16px; justify-content: flex-end;">
          <div class="pagination-controls">
            <button 
              class="pagination-btn" 
              (click)="goToFirstPage()"
              [disabled]="pageIndex === 0"
              title="Trang đầu">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
              </svg>
            </button>
            <button 
              class="pagination-btn" 
              (click)="goToPreviousPage()"
              [disabled]="pageIndex === 0"
              title="Trang trước">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 19l-7-7 7-7"/>
              </svg>
            </button>
            <span class="pagination-text">
              Trang {{ pageIndex + 1 }} / {{ getTotalPages() }}
            </span>
            <button 
              class="pagination-btn" 
              (click)="goToNextPage()"
              [disabled]="pageIndex >= getTotalPages() - 1"
              title="Trang sau">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 5l7 7-7 7"/>
              </svg>
            </button>
            <button 
              class="pagination-btn" 
              (click)="goToLastPage()"
              [disabled]="pageIndex >= getTotalPages() - 1"
              title="Trang cuối">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
              </svg>
            </button>
          </div>
        </div>

        <div *ngIf="filteredApartments.length === 0 && !loadingApartments" class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
          </svg>
          <p>{{ searchText ? 'Không tìm thấy căn hộ nào' : 'Không có căn hộ nào đã thuê trong tòa nhà này' }}</p>
        </div>
        <div *ngIf="loadingApartments" class="loading-state">
          <div class="spinner"></div>
          <p>Đang tải danh sách căn hộ...</p>
        </div>
      </div>

      <!-- Selected Apartment Info & Form -->
      <div class="form-section selected-apartment-section" *ngIf="selectedApartment && services.length > 0">
        <div class="selected-apartment-info">
          <h3 class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
            Nhập chỉ số hằng tháng cho căn hộ: <strong>{{ selectedApartment.code }}</strong>
          </h3>
          <div class="apartment-info-card">
            <div class="info-grid">
              <div class="info-item">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l-5.5 9h11z"/><circle cx="17.5" cy="17.5" r="4.5"/><path d="M3 13.5h8v8H3z"/>
                </svg>
                <span>Loại: {{ selectedApartment.type }}</span>
              </div>
              <div class="info-item">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM8 20H4v-4h4v4zm0-6H4v-4h4v4zm0-6H4V4h4v4zm6 12h-4v-4h4v4zm0-6h-4v-4h4v4zm0-6h-4V4h4v4zm6 12h-4v-4h4v4zm0-6h-4v-4h4v4zm0-6h-4V4h4v4z"/>
                </svg>
                <span>Diện tích: {{ selectedApartment.area }} m²</span>
              </div>
            </div>
          </div>
        </div>
        
        <form [formGroup]="meterReadingForm" (ngSubmit)="onSubmit()" class="reading-form">
          <!-- Loading Existing Readings -->
          <div *ngIf="checkingExisting" class="checking-indicator" style="margin-bottom: 20px;">
            <div class="spinner-small"></div>
            <span>Đang kiểm tra chỉ số hiện có...</span>
          </div>
          
          <!-- Mode Indicator - Chỉ hiển thị khi KHÔNG có readings hiện có -->
          <div class="mode-indicator" *ngIf="selectedApartmentId && !hasAnyExistingReadings && !checkingExisting" style="margin-bottom: 20px;">
            <svg class="create-mode" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
            </svg>
            <span class="create-mode-text">
              Chế độ tạo mới: Nhập chỉ số cho tháng này
            </span>
          </div>

          <!-- Dynamic Reading Inputs - Grid Layout (2 per row) -->
          <div class="readings-grid-section">
            <h4 class="grid-title">Nhập chỉ số cho các loại phí:</h4>
            <div formArrayName="readings" class="readings-grid">
              <div 
                *ngFor="let reading of readingsFormArray.controls; let i = index" 
                [formGroupName]="i" 
                class="reading-card">
                <div class="reading-card-header">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M11 21h-1l1-7H7.5c-.58 0-.57-.32-.38-.66.19-.34.05-.08.07-.12C8.48 10.94 10.42 7.54 13 3h1l-1 7h3.5c.49 0 .56.33.47.51l-.07.15C12.96 17.55 11 21 11 21z"/>
                  </svg>
                  <span class="fee-type-label">{{ getReadingFormGroup(i).get('feeType')?.value }}</span>
                </div>
                <div class="form-field">
                  <label class="field-label">Chỉ số</label>
                  <div class="input-with-icon">
                    <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14h-2v-4H9v-2h3V7h2v4h3v2h-3v4z"/>
                    </svg>
                    <input 
                      type="number" 
                      class="form-input" 
                      formControlName="readingValue" 
                      required 
                      min="0" 
                      step="0.01"
                      placeholder="Nhập chỉ số">
                  </div>
                  <div class="field-hint" *ngIf="getLatestReadingValue(getReadingFormGroup(i).get('feeType')?.value) !== null">
                    Chỉ số trước: {{ getLatestReadingValue(getReadingFormGroup(i).get('feeType')?.value) }}
                  </div>
                  <div class="field-error" *ngIf="getReadingFormGroup(i).get('readingValue')?.hasError('required') && getReadingFormGroup(i).get('readingValue')?.touched">
                    Vui lòng nhập chỉ số
                  </div>
                  <div class="field-error" *ngIf="getReadingFormGroup(i).get('readingValue')?.hasError('min') && getReadingFormGroup(i).get('readingValue')?.touched">
                    Chỉ số phải lớn hơn hoặc bằng 0
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" [disabled]="meterReadingForm.invalid || saving" class="submit-btn">
              <div class="spinner-small" *ngIf="saving"></div>
              <svg *ngIf="!saving" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
              </svg>
              {{ saving ? 'Đang lưu...' : 'Lưu chỉ số' }}
            </button>
            
            <!-- Message ngay dưới nút Lưu -->
            <div *ngIf="submitMessage" class="submit-message" [class.message-success]="submitMessageType === 'success'" [class.message-error]="submitMessageType === 'error'">
              <svg *ngIf="submitMessageType === 'success'" class="message-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              <svg *ngIf="submitMessageType === 'error'" class="message-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
              </svg>
              <span>{{ submitMessage }}</span>
            </div>
          </div>
        </form>
      </div>

      <!-- Loading Services -->
      <div class="form-section" *ngIf="loadingServices">
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Đang tải danh sách loại phí...</p>
        </div>
      </div>
    </div>
  </div>
</div>
