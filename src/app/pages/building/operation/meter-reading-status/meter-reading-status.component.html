<div class="container">
  <!-- Toast Notification -->
  <div class="toast-container" *ngIf="toast.show">
    <div class="toast" [class.toast-success]="toast.type === 'success'" [class.toast-error]="toast.type === 'error'">
      <div class="toast-icon">
        <svg *ngIf="toast.type === 'success'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        <svg *ngIf="toast.type === 'error'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="toast-message">{{ toast.message }}</div>
      <button class="toast-close" (click)="hideToast()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
  </div>

  <div class="card">
    <header>
      <h1>Báo cáo Tình trạng Ghi chỉ số</h1>
      <p>Theo dõi và quản lý chỉ số điện nước theo tòa nhà</p>
    </header>

    <!-- Filters -->
    <div class="filter-container">
      <div class="filter-row-single">
        <!-- Building Selection -->
        <div class="filter-wrapper building-wrapper">
          <label class="filter-label">Tòa nhà</label>
          <select 
            class="filter-select" 
            [(ngModel)]="selectedBuildingId" 
            (change)="onBuildingChange()"
            [disabled]="loadingBuildings">
            <option value="">-- Chọn tòa nhà --</option>
            <option *ngFor="let building of buildings" [value]="building.buildingId">
              {{ building.name || building.buildingCode }}
            </option>
          </select>
        </div>

        <!-- Billing Period -->
        <div class="filter-wrapper period-wrapper">
          <label class="filter-label">Kỳ thanh toán</label>
          <input 
            type="month" 
            class="filter-select"
            [(ngModel)]="billingPeriodInput"
            (change)="onMonthInputChange()"
            placeholder="Chọn tháng/năm">
        </div>

        <!-- Search Button -->
        <button 
          class="search-btn" 
          (click)="onSearchClick()"
          [disabled]="loadingStatus || !selectedBuildingId">
          <svg class="search-btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          Tìm kiếm
        </button>
      </div>

      <!-- Apartment Code Search -->
      <div class="search-wrapper">
        <div class="search-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
          </svg>
        </div>
        <input
          type="text"
          class="search-input"
          placeholder="Tìm theo mã căn hộ..."
          [(ngModel)]="apartmentSearchText"
          (input)="onApartmentSearchChange()"
        />
      </div>

      <!-- Status Filter -->
      <div class="filter-row-single" style="margin-top: 1rem;">
        <div class="filter-wrapper status-wrapper">
          <label class="filter-label">Lọc theo trạng thái</label>
          <select 
            class="filter-select" 
            [(ngModel)]="statusFilter" 
            (change)="onStatusFilterChange()">
            <option value="">Tất cả trạng thái</option>
            <option *ngFor="let status of getStatusOptions()" [value]="status">
              {{ status }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loadingStatus" class="text-center" style="padding: 2rem;">
      <p>Đang tải báo cáo...</p>
    </div>

    <!-- Table -->
    <div *ngIf="!loadingStatus && hasData" class="table-container">
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Căn hộ</th>
              <th>Loại phí</th>
              <th>Chỉ số</th>
              <th>Trạng thái</th>
              <th>Ngày ghi</th>
              <th>Người ghi</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let reading of getFlatReadingsList(); let i = index"
                [class.row-not-recorded]="reading.status === 'Chưa ghi'"
                [class.row-locked]="reading.status === 'Đã ghi - Đã khóa'"
                [class.row-open]="reading.status === 'Đã ghi - Mở'">
              <td class="font-medium" *ngIf="isFirstReadingInApartment(reading, i)">
                {{ reading.apartmentCode }}
              </td>
              <td *ngIf="!isFirstReadingInApartment(reading, i)"></td>
              <td>{{ reading.feeType }}</td>
              <td class="font-medium">
                <span *ngIf="reading.readingValue !== null && reading.readingValue !== undefined" class="reading-value">
                  {{ reading.readingValue | number:'1.2-2' }}
                </span>
                <span *ngIf="reading.readingValue === null || reading.readingValue === undefined" class="na">
                  N/A
                </span>
              </td>
              <td>
                <span [class]="getStatusClass(reading.status)" class="status-badge">
                  {{ reading.status }}
                </span>
              </td>
              <td>
                <span *ngIf="reading.readingDate">{{ formatDate(reading.readingDate) }}</span>
                <span *ngIf="!reading.readingDate" class="na">N/A</span>
              </td>
              <td>
                <span *ngIf="reading.recordedByName">{{ reading.recordedByName }}</span>
                <span *ngIf="!reading.recordedByName" class="na">N/A</span>
              </td>
            </tr>
            <tr *ngIf="getFlatReadingsList().length === 0">
              <td colspan="6" class="no-results">Không tìm thấy dữ liệu nào phù hợp.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div *ngIf="totalApartments > 0" class="pagination-container">
        <div class="pagination-info">
          Hiển thị {{ getStartIndex() + 1 }} - {{ getEndIndex() }} trong tổng số {{ totalApartments }} căn hộ
        </div>
        <div class="pagination-controls">
          <button 
            class="pagination-btn" 
            (click)="goToFirstPage()"
            [disabled]="pageIndex === 0"
            title="Trang đầu">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
            </svg>
          </button>
          <button 
            class="pagination-btn" 
            (click)="goToPreviousPage()"
            [disabled]="pageIndex === 0"
            title="Trang trước">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 19l-7-7 7-7"/>
            </svg>
          </button>
          <span class="pagination-text">
            Trang {{ pageIndex + 1 }} / {{ getTotalPages() }}
          </span>
          <button 
            class="pagination-btn" 
            (click)="goToNextPage()"
            [disabled]="pageIndex >= getTotalPages() - 1"
            title="Trang sau">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 5l7 7-7 7"/>
            </svg>
          </button>
          <button 
            class="pagination-btn" 
            (click)="goToLastPage()"
            [disabled]="pageIndex >= getTotalPages() - 1"
            title="Trang cuối">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loadingStatus && !hasData && selectedBuildingId && billingPeriod" class="empty-state">
      <h3>Không có dữ liệu</h3>
      <p>Không tìm thấy dữ liệu cho tòa nhà và kỳ thanh toán đã chọn</p>
    </div>

    <!-- Initial State -->
    <div *ngIf="!loadingStatus && !hasData && (!selectedBuildingId || !billingPeriod)" class="empty-state">
      <h3>Bắt đầu xem báo cáo</h3>
      <p>Vui lòng chọn tòa nhà và kỳ thanh toán để xem báo cáo tình trạng ghi chỉ số</p>
    </div>
  </div>
</div>
