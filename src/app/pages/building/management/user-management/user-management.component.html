<mat-card class="user-management-container mat-elevation-z2">
    <mat-card-header>
        <mat-card-title><mat-icon class="align-top mr-2">group</mat-icon> Quản Lý Tài Khoản Người Dùng</mat-card-title>
    </mat-card-header>

    <mat-card-content>
        <mat-tab-group [selectedIndex]="activeTab === 'staffs' ? 0 : 1"
            (selectedIndexChange)="setActiveTab($event === 0 ? 'staffs' : 'residents')">

            <mat-tab label="Danh Sách Nhân Viên">

                <div class="tab-content pt-3">
                    <mat-progress-bar *ngIf="isLoading && activeTab === 'staffs'"
                        mode="indeterminate"></mat-progress-bar>

                    <div class="toolbar mb-3 d-flex justify-content-end">
                        <button mat-flat-button color="primary" [routerLink]="['create-staff']">
                            <mat-icon>person_add</mat-icon> Thêm Nhân Viên Mới
                        </button>
                    </div>

                    <div class="table-container">
                        <table mat-table [dataSource]="staffs" class="full-width-table mat-elevation-z1">

                            <ng-container matColumnDef="name">
                                <th mat-header-cell *matHeaderCellDef> Họ Tên </th>
                                <td mat-cell *matCellDef="let user"> {{ user.name }} </td>
                            </ng-container>

                            <ng-container matColumnDef="role">
                                <th mat-header-cell *matHeaderCellDef> Chức Vụ </th>
                                <td mat-cell *matCellDef="let user"> {{ user.roleName }} </td>
                            </ng-container>

                            <ng-container matColumnDef="contact">
                                <th mat-header-cell *matHeaderCellDef> Liên Hệ </th>
                                <td mat-cell *matCellDef="let user">
                                    <div class="small text-muted">{{ user.email }}</div>
                                    <div>{{ user.phone }}</div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="assignment">
                                <th mat-header-cell *matHeaderCellDef> Quản Lý Tòa </th>
                                <td mat-cell *matCellDef="let user">
                                    <span *ngIf="user.assignedBuildingCodes && user.assignedBuildingCodes.length > 0">{{
                                        user.assignedBuildingCodes.join(', ') }}</span>
                                    <span *ngIf="!user.assignedBuildingCodes || user.assignedBuildingCodes.length === 0"
                                        class="text-danger">Chưa phân công</span>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="status">
                                <th mat-header-cell *matHeaderCellDef> Trạng Thái </th>
                                <td mat-cell *matCellDef="let user">
                                    <mat-chip-listbox>
                                        <mat-chip [color]="user.status.toLowerCase() === 'active' ? 'primary' : 'warn'">
                                            {{ user.status.toLowerCase() === 'active' ? 'Đang hoạt động' : 'Vô hiệu hóa'
                                            }}
                                        </mat-chip>
                                    </mat-chip-listbox>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef> Thao Tác </th>
                                <td mat-cell *matCellDef="let user">
                                    <button mat-icon-button
                                        [color]="user.status.toLowerCase() === 'active' ? 'warn' : 'primary'"
                                        matTooltip="{{ user.status.toLowerCase() === 'active' ? 'Vô hiệu hóa' : 'Kích hoạt' }} tài khoản"
                                        (click)="toggleStatus(user)">
                                        <mat-icon>{{ user.status.toLowerCase() === 'active' ? 'lock' : 'lock_open'
                                            }}</mat-icon>
                                    </button>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="staffDisplayedColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: staffDisplayedColumns;"></tr>

                            <tr class="mat-row" *matNoDataRow>
                                <td class="mat-cell text-center p-3" [attr.colspan]="staffDisplayedColumns.length">
                                    {{ staffsPagedList?.totalCount === 0 ? 'Không tìm thấy dữ liệu nhân viên.' : 'Đang
                                    tải dữ liệu...' }}
                                </td>
                            </tr>
                        </table>
                    </div>


                    <mat-paginator *ngIf="staffsPagedList && staffsPagedList.totalCount > staffsPagedList.pageSize"
                        [length]="staffsPagedList.totalCount" [pageSize]="staffsPagedList.pageSize"
                        [pageIndex]="staffsPagedList.pageNumber - 1" (page)="onStaffPageChange($event.pageIndex)"
                        [pageSizeOptions]="[10, 25, 50]" showFirstLastButtons>
                    </mat-paginator>
                </div>
            </mat-tab>

            <mat-tab label="Danh Sách Cư Dân">
                <div class="tab-content pt-3">
                    <mat-progress-bar *ngIf="isLoading && activeTab === 'residents'"
                        mode="indeterminate"></mat-progress-bar>

                    <div class="toolbar mb-3 d-flex justify-content-end">
                        <button mat-flat-button color="primary" [routerLink]="['create-resident']">
                            <mat-icon>person_add</mat-icon> Thêm Cư Dân Mới
                        </button>
                    </div>

                    <div class="table-container">
                        <table mat-table [dataSource]="residents" class="full-width-table mat-elevation-z1">
                            <ng-container matColumnDef="name">
                                <th mat-header-cell *matHeaderCellDef> Họ Tên </th>
                                <td mat-cell *matCellDef="let user"> {{ user.name }} </td>
                            </ng-container>

                            <ng-container matColumnDef="apartmentCode">
                                <th mat-header-cell *matHeaderCellDef> Mã Căn Hộ </th>
                                <td mat-cell *matCellDef="let user"> {{ user.apartmentCode || 'Chưa phân bổ' }} </td>
                            </ng-container>

                            <ng-container matColumnDef="contact">
                                <th mat-header-cell *matHeaderCellDef> Liên Hệ </th>
                                <td mat-cell *matCellDef="let user">
                                    <div class="small text-muted">{{ user.email }}</div>
                                    <div>{{ user.phone }}</div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="status">
                                <th mat-header-cell *matHeaderCellDef> Trạng Thái </th>
                                <td mat-cell *matCellDef="let user">
                                    <mat-chip-listbox>
                                        <mat-chip [color]="user.status.toLowerCase() === 'active' ? 'primary' : 'warn'">
                                            {{ user.status.toLowerCase() === 'active' ? 'Đang hoạt động' : 'Vô hiệu hóa'
                                            }}
                                        </mat-chip>
                                    </mat-chip-listbox>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef> Thao Tác </th>
                                <td mat-cell *matCellDef="let user">
                                    <button mat-icon-button
                                        [color]="user.status.toLowerCase() === 'active' ? 'warn' : 'primary'"
                                        matTooltip="{{ user.status.toLowerCase() === 'active' ? 'Vô hiệu hóa' : 'Kích hoạt' }} tài khoản"
                                        (click)="toggleStatus(user)">
                                        <mat-icon>{{ user.status.toLowerCase() === 'active' ? 'lock' : 'lock_open'
                                            }}</mat-icon>
                                    </button>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="residentDisplayedColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: residentDisplayedColumns;"></tr>

                            <tr class="mat-row" *matNoDataRow>
                                <td class="mat-cell text-center p-3" [attr.colspan]="residentDisplayedColumns.length">
                                    {{ residentsPagedList?.totalCount === 0 ? 'Không tìm thấy dữ liệu cư dân.' : 'Đang
                                    tải dữ liệu...' }}
                                </td>
                            </tr>
                        </table>
                    </div>

                    <mat-paginator
                        *ngIf="residentsPagedList && residentsPagedList.totalCount > residentsPagedList.pageSize"
                        [length]="residentsPagedList.totalCount" [pageSize]="residentsPagedList.pageSize"
                        [pageIndex]="residentsPagedList.pageNumber - 1" (page)="onResidentPageChange($event.pageIndex)"
                        [pageSizeOptions]="[10, 25, 50]" showFirstLastButtons>
                    </mat-paginator>
                </div>
            </mat-tab>
        </mat-tab-group>
    </mat-card-content>
</mat-card>