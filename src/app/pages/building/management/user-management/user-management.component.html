<mat-card class="user-management-container mat-elevation-z2">
    <mat-card-header>
        <mat-card-title><mat-icon class="align-top mr-2">group</mat-icon> Quản Lý Tài Khoản Người Dùng</mat-card-title>
    </mat-card-header>

    <mat-card-content>
        <mat-tab-group [selectedIndex]="activeTab === 'staffs' ? 0 : 1"
            (selectedIndexChange)="setActiveTab($event === 0 ? 'staffs' : 'residents')">

            <mat-tab label="Tài khoản Nhân Viên">
                <div class="tab-content pt-3">
                    <mat-progress-bar *ngIf="isLoading && activeTab === 'staffs'" mode="indeterminate"></mat-progress-bar>

                    <div class="filter-toolbar row align-items-center mb-3 g-2">
                        <div class="col-md-4">
                            <mat-form-field appearance="outline" class="w-100 density-sm">
                                <mat-label>Tìm kiếm (Tên, Email, SĐT...)</mat-label>
                                <input matInput [ngModel]="staffQueryParams.searchTerm" (input)="onSearch($event)" placeholder="Nhập từ khóa...">
                                <mat-icon matSuffix>search</mat-icon>
                            </mat-form-field>
                        </div>

                        <div class="col-md-3">
                            <mat-form-field appearance="outline" class="w-100 density-sm">
                                <mat-label>Trạng thái</mat-label>
                                <mat-select [(ngModel)]="staffQueryParams.status" (selectionChange)="onStatusChange()">
                                    <mat-option *ngFor="let opt of statusOptions" [value]="opt.value">
                                        {{opt.label}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>

                        <div class="col-md-5 text-end">
                            <button mat-flat-button color="primary" (click)="openCreateStaffDialog()">
                                <mat-icon>person_add</mat-icon> Thêm Nhân Viên
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table mat-table [dataSource]="staffs" matSort (matSortChange)="onSortChange($event)" class="full-width-table mat-elevation-z1">

                            <ng-container matColumnDef="name">
                                <th mat-header-cell *matHeaderCellDef mat-sort-header> Họ Tên </th>
                                <td mat-cell *matCellDef="let user"> 
                                    <div class="fw-bold">{{ user.name }}</div>
                                    <div class="small text-muted" *ngIf="user.staffCode">MNV: {{user.staffCode}}</div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="role">
                                <th mat-header-cell *matHeaderCellDef mat-sort-header> Chức Vụ </th>
                                <td mat-cell *matCellDef="let user"> {{ user.roleName }} </td>
                            </ng-container>

                            <ng-container matColumnDef="contact">
                                <th mat-header-cell *matHeaderCellDef> Liên Hệ </th>
                                <td mat-cell *matCellDef="let user">
                                    <div class="small text-muted">{{ user.email }}</div>
                                    <div>{{ user.phone }}</div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="assignment">
                                <th mat-header-cell *matHeaderCellDef> Quản Lý Tòa </th>
                                <td mat-cell *matCellDef="let user">
                                    <span *ngIf="user.assignedBuildingCodes && user.assignedBuildingCodes.length > 0">
                                        {{ user.assignedBuildingCodes.join(', ') }}
                                    </span>
                                    <span *ngIf="!user.assignedBuildingCodes || user.assignedBuildingCodes.length === 0" class="text-danger small">
                                        Chưa phân công
                                    </span>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="status">
                                <th mat-header-cell *matHeaderCellDef mat-sort-header> Trạng Thái </th>
                                <td mat-cell *matCellDef="let user">
                                    <mat-chip-listbox>
                                        <mat-chip [color]="user.status.toLowerCase() === 'active' ? 'primary' : 'warn'" highlighted>
                                            {{ user.status.toLowerCase() === 'active' ? 'Active' : 'Inactive' }}
                                        </mat-chip>
                                    </mat-chip-listbox>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef> Thao Tác </th>
                                <td mat-cell *matCellDef="let user">
                                    <button mat-icon-button
                                        [color]="user.status.toLowerCase() === 'active' ? 'warn' : 'primary'"
                                        matTooltip="{{ user.status.toLowerCase() === 'active' ? 'Vô hiệu hóa' : 'Kích hoạt' }} tài khoản"
                                        (click)="toggleStatus(user)">
                                        <mat-icon>{{ user.status.toLowerCase() === 'active' ? 'lock' : 'lock_open' }}</mat-icon>
                                    </button>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="staffDisplayedColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: staffDisplayedColumns;"></tr>

                            <tr class="mat-row" *matNoDataRow>
                                <td class="mat-cell text-center p-4 text-muted" [attr.colspan]="staffDisplayedColumns.length">
                                    {{ staffsPagedList?.totalCount === 0 ? 'Không tìm thấy nhân viên nào.' : 'Đang tải dữ liệu...' }}
                                </td>
                            </tr>
                        </table>
                    </div>

                    <mat-paginator *ngIf="staffsPagedList && staffsPagedList.totalCount > 0"
                        [length]="staffsPagedList.totalCount" 
                        [pageSize]="staffsPagedList.pageSize"
                        [pageIndex]="staffsPagedList.pageNumber - 1" 
                        (page)="onStaffPageChange($event.pageIndex)"
                        [pageSizeOptions]="[10, 25, 50]" 
                        showFirstLastButtons>
                    </mat-paginator>
                </div>
            </mat-tab>

            <mat-tab label="Tài khoản Cư Dân">
                <div class="tab-content pt-3">
                    <mat-progress-bar *ngIf="isLoading && activeTab === 'residents'" mode="indeterminate"></mat-progress-bar>

                    <div class="filter-toolbar row align-items-center mb-3 g-2">
                        <div class="col-md-4">
                            <mat-form-field appearance="outline" class="w-100 density-sm">
                                <mat-label>Tìm kiếm (Tên, Căn hộ...)</mat-label>
                                <input matInput [ngModel]="residentQueryParams.searchTerm" (input)="onSearch($event)" placeholder="Nhập từ khóa...">
                                <mat-icon matSuffix>search</mat-icon>
                            </mat-form-field>
                        </div>

                        <div class="col-md-3">
                            <mat-form-field appearance="outline" class="w-100 density-sm">
                                <mat-label>Trạng thái</mat-label>
                                <mat-select [(ngModel)]="residentQueryParams.status" (selectionChange)="onStatusChange()">
                                    <mat-option *ngFor="let opt of statusOptions" [value]="opt.value">
                                        {{opt.label}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        </div>

                    <div class="table-container">
                        <table mat-table [dataSource]="residents" matSort (matSortChange)="onSortChange($event)" class="full-width-table mat-elevation-z1">
                            
                            <ng-container matColumnDef="name">
                                <th mat-header-cell *matHeaderCellDef mat-sort-header> Họ Tên </th>
                                <td mat-cell *matCellDef="let user"> {{ user.name }} </td>
                            </ng-container>

                            <ng-container matColumnDef="apartmentCode">
                                <th mat-header-cell *matHeaderCellDef mat-sort-header> Mã Căn Hộ </th>
                                <td mat-cell *matCellDef="let user"> 
                                    <span class="fw-bold text-primary">{{ user.apartmentCode || 'Chưa gán' }}</span> 
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="contact">
                                <th mat-header-cell *matHeaderCellDef> Liên Hệ </th>
                                <td mat-cell *matCellDef="let user">
                                    <div class="small text-muted">{{ user.email }}</div>
                                    <div>{{ user.phone }}</div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="status">
                                <th mat-header-cell *matHeaderCellDef mat-sort-header> Trạng Thái </th>
                                <td mat-cell *matCellDef="let user">
                                    <mat-chip-listbox>
                                        <mat-chip [color]="user.status.toLowerCase() === 'active' ? 'primary' : 'warn'" highlighted>
                                            {{ user.status.toLowerCase() === 'active' ? 'Active' : 'Inactive' }}
                                        </mat-chip>
                                    </mat-chip-listbox>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef> Thao Tác </th>
                                <td mat-cell *matCellDef="let user">
                                    <button mat-icon-button
                                        [color]="user.status.toLowerCase() === 'active' ? 'warn' : 'primary'"
                                        matTooltip="{{ user.status.toLowerCase() === 'active' ? 'Vô hiệu hóa' : 'Kích hoạt' }} tài khoản"
                                        (click)="toggleStatus(user)">
                                        <mat-icon>{{ user.status.toLowerCase() === 'active' ? 'lock' : 'lock_open' }}</mat-icon>
                                    </button>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="residentDisplayedColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: residentDisplayedColumns;"></tr>

                            <tr class="mat-row" *matNoDataRow>
                                <td class="mat-cell text-center p-4 text-muted" [attr.colspan]="residentDisplayedColumns.length">
                                    {{ residentsPagedList?.totalCount === 0 ? 'Không tìm thấy cư dân nào.' : 'Đang tải dữ liệu...' }}
                                </td>
                            </tr>
                        </table>
                    </div>

                    <mat-paginator *ngIf="residentsPagedList && residentsPagedList.totalCount > 0"
                        [length]="residentsPagedList.totalCount" 
                        [pageSize]="residentsPagedList.pageSize"
                        [pageIndex]="residentsPagedList.pageNumber - 1" 
                        (page)="onResidentPageChange($event.pageIndex)"
                        [pageSizeOptions]="[10, 25, 50]" 
                        showFirstLastButtons>
                    </mat-paginator>
                </div>
            </mat-tab>
        </mat-tab-group>
    </mat-card-content>
</mat-card>