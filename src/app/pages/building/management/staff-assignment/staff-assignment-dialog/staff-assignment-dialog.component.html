<div class="dialog-header">
  <h2 mat-dialog-title>{{ isEditMode ? 'Cập nhật Phân công' : 'Gán Nhân viên mới' }}</h2>
  <button mat-icon-button class="close-btn" (click)="close()">
    <mat-icon>close</mat-icon>
  </button>
</div>

<mat-dialog-content>
  <form [formGroup]="form" class="assignment-form">
    
    <div *ngIf="errorMessage" class="alert alert-danger">
      <mat-icon>error_outline</mat-icon>
      <span>{{ errorMessage }}</span>
    </div>

    <ng-container *ngIf="!isEditMode">
      
      <div class="form-group">
        <label>Tòa nhà <span class="required">*</span></label>
        <mat-form-field appearance="outline" class="full-width-mat">
          <mat-select formControlName="buildingId" placeholder="-- Chọn tòa nhà --">
            
            <div class="select-search-container">
              <input class="select-search-input" placeholder="Tìm tòa nhà..." 
                     [formControl]="buildingSearchCtrl" (keydown)="$event.stopPropagation()">
            </div>

            <mat-option *ngFor="let b of filteredBuildings | async" [value]="b.buildingId">
              {{ b.name }} ({{ b.buildingCode }})
            </mat-option>
            
            <mat-option *ngIf="(filteredBuildings | async)?.length === 0" disabled class="no-data-option">
              Không tìm thấy tòa nhà
            </mat-option>
          </mat-select>
          <mat-error *ngIf="isFieldInvalid('buildingId')">Vui lòng chọn tòa nhà</mat-error>
        </mat-form-field>
      </div>

      <div class="form-group">
        <label>Nhân viên (Staff) <span class="required">*</span></label>
        <mat-form-field appearance="outline" class="full-width-mat">
          <mat-select formControlName="userId" placeholder="-- Chọn nhân viên --">
            
            <div class="select-search-container">
              <input class="select-search-input" placeholder="Tìm tên, mã hoặc email..." 
                     [formControl]="staffSearchCtrl" (keydown)="$event.stopPropagation()">
            </div>

            <ng-container *ngFor="let group of filteredStaffGroups | async">
              <mat-optgroup [label]="group.name" *ngIf="group.staffs.length > 0">
                <mat-option *ngFor="let u of group.staffs" [value]="u.userId">
                  {{ u.name }} ({{ u.staffCode }} - {{ u.roleName }})
                </mat-option>
              </mat-optgroup>
            </ng-container>

            <mat-option *ngIf="(filteredStaffGroups | async)?.length === 0" disabled class="no-data-option">
              Không tìm thấy nhân viên
            </mat-option>
          </mat-select>
          <mat-error *ngIf="isFieldInvalid('userId')">Vui lòng chọn nhân viên</mat-error>
        </mat-form-field>
      </div>

    </ng-container>

    <ng-container *ngIf="isEditMode">
      <div class="info-box">
        <p><strong>Nhân viên:</strong> {{ data.assignment?.staffName }} ({{ data.assignment?.staffCode }})</p>
        <p><strong>Tòa nhà:</strong> {{ data.assignment?.buildingName }}</p>
      </div>
    </ng-container>

    <div class="form-row">
      <div class="form-group half">
        <label>Vị trí/Chức danh <span class="required">*</span></label>
        <input type="text" class="form-control" formControlName="position" placeholder="VD: Kỹ thuật viên, Bảo vệ...">
        <small class="error-text" *ngIf="isFieldInvalid('position')">Nhập vị trí công việc</small>
      </div>

      <div class="form-group half">
        <label>Ngày bắt đầu <span class="required">*</span></label>
        <input type="date" class="form-control" formControlName="startDate" [readonly]="isEditMode">
      </div>
    </div>

    <div class="form-group">
      <label>Phạm vi công việc (Scope)</label>
      <textarea class="form-control" formControlName="scopeOfWork" rows="3" placeholder="Mô tả chi tiết công việc..."></textarea>
    </div>

    <div class="form-row" *ngIf="isEditMode">
      <div class="form-group half">
        <label>Trạng thái</label>
        <select class="form-control" formControlName="isActive">
          <option [ngValue]="true">Active (Đang làm)</option>
          <option [ngValue]="false">Inactive (Đã nghỉ)</option>
        </select>
      </div>
      <div class="form-group half">
        <label>Ngày kết thúc</label>
        <input type="date" class="form-control" formControlName="endDate">
        <small class="error-text" *ngIf="form.hasError('endBeforeStart') && (form.get('endDate')?.touched || form.get('endDate')?.dirty)">Ngày kết thúc phải sau ngày bắt đầu</small>
      </div>
    </div>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="close()">Hủy</button>
  <button mat-raised-button color="primary" (click)="save()" [disabled]="form.invalid || isSubmitting">
    <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
    <span *ngIf="!isSubmitting">{{ isEditMode ? 'Cập nhật' : 'Gán' }}</span>
  </button>
</mat-dialog-actions>