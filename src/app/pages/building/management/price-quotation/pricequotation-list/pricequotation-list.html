<mat-card>
  <mat-card-header class="card-header">
    <mat-card-title>Quản lý Đơn giá Dịch vụ</mat-card-title>
    <div class="header-actions">
      <button mat-flat-button color="primary" (click)="goToCreate()">
        <mat-icon>add</mat-icon>
        Thêm Đơn giá mới
      </button>
    </div>
  </mat-card-header>

  <mat-card-content>
    <div class="filter-bar">
      <mat-form-field appearance="outline" class="filter-select">
        <mat-label>Lọc theo Tòa nhà</mat-label>
        <mat-select [(ngModel)]="queryParams.buildingId" (ngModelChange)="onBuildingFilterChange()">
          <mat-option [value]="''">Tất cả Tòa nhà</mat-option>
          <mat-option *ngFor="let building of buildings" [value]="building.buildingId">
            {{ building.buildingCode }} - {{ building.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      <mat-form-field appearance="outline" class="filter-search">
        <mat-label>Tìm theo Tên phí (FeeType)</mat-label>
        <input matInput [ngModel]="queryParams.searchTerm" (input)="onSearchInput($event)" placeholder="Ví dụ: Phí quản lý...">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>

    <div *ngIf="isLoading" class="loading-spinner">
      <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
    </div>

    <div *ngIf="!isLoading && (!pagedData || pagedData.totalCount === 0)" class="no-data-row">
      Không tìm thấy đơn giá nào.
    </div>

    <div *ngIf="!isLoading && pagedData && pagedData.totalCount > 0" class="table-container">
      <table mat-table [dataSource]="pagedData.items">

        <ng-container matColumnDef="feeType">
          <th mat-header-cell *matHeaderCellDef> Tên phí </th>
          <td mat-cell *matCellDef="let row"> {{row.feeType}} </td>
        </ng-container>
        
        <ng-container matColumnDef="buildingCode">
          <th mat-header-cell *matHeaderCellDef> Tòa nhà </th>
          <td mat-cell *matCellDef="let row"> {{row.buildingCode}} </td>
        </ng-container>
        
        <ng-container matColumnDef="calculationMethod">
          <th mat-header-cell *matHeaderCellDef> Phương thức tính </th>
          <td mat-cell *matCellDef="let row"> {{row.calculationMethod}} </td>
        </ng-container>
        
        <ng-container matColumnDef="unitPrice">
          <th mat-header-cell *matHeaderCellDef> Đơn giá </th>
          <td mat-cell *matCellDef="let row"> 
            <span *ngIf="row.calculationMethod !== 'TIERED'">{{row.unitPrice | number}}</span>
            <span *ngIf="row.calculationMethod === 'TIERED'" class="tiered-note" matTooltip="Xem Sửa để xem các bậc giá">(Tính lũy tiến)</span>
          </td>
        </ng-container>
        
        <ng-container matColumnDef="unit">
          <th mat-header-cell *matHeaderCellDef> Đơn vị </th>
          <td mat-cell *matCellDef="let row"> {{row.unit}} </td>
        </ng-container>
        
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> Hành động </th>
          <td mat-cell *matCellDef="let row">
            <button mat-icon-button color="primary" (click)="goToEdit(row.priceQuotationId)" matTooltip="Sửa">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="deleteQuotation(row.priceQuotationId, row.feeType)" matTooltip="Xóa">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        
      </table>
    </div>

    <nav *ngIf="!isLoading && pagedData && pagedData.totalPages > 1" class="pagination-container" aria-label="Page navigation">
      <small class="pagination-summary">
        Hiển thị 
        <strong>{{ pagedData.items.length }}</strong> 
        trong tổng số 
        <strong>{{ pagedData.totalCount }}</strong> 
        mục
      </small>
      
      <ul class="pagination">
        <li class="page-item" [class.disabled]="!pagedData.hasPreviousPage">
          <a class="page-link" href="javascript:void(0)" aria-label="Previous" (click)="onPageChange(pagedData.pageNumber - 1)">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
        
        <li class="page-item" 
            *ngFor="let pageNum of getPaginationArray()" 
            [class.active]="pageNum === pagedData.pageNumber">
          <a class="page-link" href="javascript:void(0)" (click)="onPageChange(pageNum)">
            {{ pageNum }}
          </a>
        </li>
        
        <li class="page-item" [class.disabled]="!pagedData.hasNextPage">
          <a class="page-link" href="javascript:void(0)" aria-label="Next" (click)="onPageChange(pagedData.pageNumber + 1)">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      </ul>
    </nav>

  </mat-card-content>
</mat-card>