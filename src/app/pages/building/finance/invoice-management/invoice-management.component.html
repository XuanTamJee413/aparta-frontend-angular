<div class="container">
  <div class="card">
    <header>
      <h1>Qu·∫£n l√Ω H√≥a ƒë∆°n</h1>
      <p>Danh s√°ch h√≥a ƒë∆°n theo t√≤a nh√† v√† cƒÉn h·ªô</p>
    </header>

    <!-- Tabs -->
    <div class="tabs-container">
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'monthly'"
        (click)="switchTab('monthly')">
        H√≥a ƒë∆°n Th√°ng
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'one-time'"
        (click)="switchTab('one-time')">
        Ph√≠ ph√°t sinh
      </button>
    </div>

    <!-- Filters -->
    <div class="filter-container">
      <div class="filter-row-single">
        <!-- Building Selection -->
        <div class="filter-wrapper building-wrapper">
          <label class="filter-label">T√≤a nh√†</label>
          <select 
            class="filter-select" 
            [(ngModel)]="selectedBuildingId" 
            (change)="onBuildingChange()"
            [disabled]="isLoading">
            <option value="">-- Ch·ªçn t√≤a nh√† --</option>
            <option *ngFor="let building of buildings" [value]="building.buildingId">
              {{ building.name || building.buildingCode }}
            </option>
          </select>
        </div>

        <!-- Status Filter -->
        <div class="filter-wrapper status-wrapper">
          <label class="filter-label">Tr·∫°ng th√°i</label>
          <select 
            class="filter-select" 
            [(ngModel)]="selectedStatus" 
            (change)="onStatusChange()"
            [disabled]="isLoading">
            <option *ngFor="let status of statusOptions" [value]="status.value">
              {{ status.label }}
            </option>
          </select>
        </div>

        <!-- Search Button -->
        <button 
          class="search-btn" 
          (click)="onSearchClick()"
          [disabled]="isLoading || !selectedBuildingId">
          <svg class="search-btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          T√¨m ki·∫øm
        </button>
      </div>

      <!-- Apartment Code Search -->
      <div class="search-wrapper">
        <div class="search-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
          </svg>
        </div>
        <input
          type="text"
          class="search-input"
          placeholder="T√¨m theo m√£ cƒÉn h·ªô..."
          [(ngModel)]="apartmentCodeSearch"
          (input)="onApartmentCodeSearch()"
        />
      </div>
    </div>

    <!-- Loading State -->
    @if (isLoading) {
      <div class="text-center" style="padding: 2rem;">
        <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
      </div>
    }

    <!-- Error State -->
    @if (error && !isLoading) {
      <div class="alert alert-danger" style="margin-top: 1.5rem;">
        {{ error }}
      </div>
    }

    <!-- TAB 1: Monthly Invoices -->
    @if (activeTab === 'monthly' && !isLoading && !error) {
      <div class="table-container">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>M√£ CƒÉn h·ªô</th>
                <th>C∆∞ d√¢n</th>
                <th>Lo·∫°i ph√≠</th>
                <th>S·ªë ti·ªÅn</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H·∫°n ch√≥t</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody>
              @for (invoice of flatInvoices; track invoice.invoiceId) {
                <tr>
                  <td class="font-medium">{{ invoice.apartmentCode }}</td>
                  <td>{{ invoice.residentName || 'N/A' }}</td>
                  <td>{{ invoice.feeType }}</td>
                  <td class="font-medium">{{ formatCurrency(invoice.price) }}</td>
                  <td>
                    <span [class]="getStatusClass(invoice.status)">
                      {{ getStatusLabel(invoice.status) }}
                    </span>
                  </td>
                  <td>{{ formatDate(invoice.endDate) }}</td>
                  <td class="actions">
                    <button class="action-view-btn" (click)="viewDetail(invoice.invoiceId)">
                      <svg class="action-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                      Xem Chi ti·∫øt
                    </button>
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="7" class="no-results">Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n n√†o ph√π h·ª£p.</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }

    <!-- TAB 2: One-Time Invoices -->
    @if (activeTab === 'one-time' && !isLoading && !error) {
      <div class="table-container">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Ng√†y t·∫°o</th>
                <th>CƒÉn h·ªô</th>
                <th>N·ªôi dung</th>
                <th>S·ªë ti·ªÅn</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody>
              @for (invoice of oneTimeInvoices; track invoice.invoiceId) {
                <tr>
                  <td>{{ formatDate(invoice.startDate) }}</td>
                  <td class="font-medium">{{ invoice.apartmentCode }}</td>
                  <td>
                    @let parsed = parseDescription(invoice.description);
                    {{ parsed.itemDescription }}
                  </td>
                  <td class="font-medium">{{ formatCurrency(invoice.price) }}</td>
                  <td>
                    <span [class]="getStatusClass(invoice.status)">
                      {{ getStatusLabel(invoice.status) }}
                    </span>
                  </td>
                  <td class="actions">
                    <div class="action-buttons">
                      <button class="action-view-btn" (click)="viewDetail(invoice.invoiceId)">
                        <svg class="action-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        Xem Chi ti·∫øt
                      </button>
                      <button 
                        *ngIf="invoice.status === 'PENDING'"
                        type="button"
                        class="btn-delete"
                        (click)="deleteInvoice(invoice.invoiceId)"
                        title="H·ªßy">
                        üóëÔ∏è
                      </button>
                      <button 
                        *ngIf="invoice.status === 'PENDING'"
                        type="button"
                        class="btn-mark-paid"
                        (click)="markAsPaid(invoice.invoiceId)"
                        title="Thu ti·ªÅn m·∫∑t">
                        üíµ
                      </button>
                    </div>
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="6" class="no-results">Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n n√†o ph√π h·ª£p.</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }
  </div>
</div>
