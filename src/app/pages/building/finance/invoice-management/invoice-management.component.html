<div class="container">
  <div class="card">
    <header>
      <h1>Quản lý Hóa đơn</h1>
      <p>Danh sách hóa đơn theo tòa nhà và căn hộ</p>
    </header>

    <!-- Tabs -->
    <div class="tabs-container">
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'monthly'"
        (click)="switchTab('monthly')">
        Hóa đơn Tháng
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'one-time'"
        (click)="switchTab('one-time')">
        Phí phát sinh
      </button>
    </div>

    <!-- Filters -->
    <div class="filter-container">
      <div class="filter-row-single">
        <!-- Building Selection -->
        <div class="filter-wrapper building-wrapper">
          <label class="filter-label">Tòa nhà</label>
          <select 
            class="filter-select" 
            [(ngModel)]="selectedBuildingId" 
            (change)="onBuildingChange()"
            [disabled]="isLoading">
            <option value="">-- Chọn tòa nhà --</option>
            <option *ngFor="let building of buildings" [value]="building.buildingId">
              {{ building.name || building.buildingCode }}
            </option>
          </select>
        </div>

        <!-- Status Filter -->
        <div class="filter-wrapper status-wrapper">
          <label class="filter-label">Trạng thái</label>
          <select 
            class="filter-select" 
            [(ngModel)]="selectedStatus" 
            (change)="onStatusChange()"
            [disabled]="isLoading">
            <option *ngFor="let status of statusOptions" [value]="status.value">
              {{ status.label }}
            </option>
          </select>
        </div>

        <!-- Search Button -->
        <button 
          class="search-btn" 
          (click)="onSearchClick()"
          [disabled]="isLoading || !selectedBuildingId">
          <svg class="search-btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          Tìm kiếm
        </button>
      </div>

      <!-- Apartment Code Search -->
      <div class="search-wrapper">
        <div class="search-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
          </svg>
        </div>
        <input
          type="text"
          class="search-input"
          placeholder="Tìm theo mã căn hộ..."
          [(ngModel)]="apartmentCodeSearch"
          (input)="onApartmentCodeSearch()"
        />
      </div>
    </div>

    <!-- Loading State -->
    @if (isLoading) {
      <div class="text-center" style="padding: 2rem;">
        <p>Đang tải dữ liệu...</p>
      </div>
    }

    <!-- Error State -->
    @if (error && !isLoading) {
      <div class="alert alert-danger" style="margin-top: 1.5rem;">
        {{ error }}
        <button class="alert-close" (click)="error = null">×</button>
      </div>
    }

    <!-- Success Message -->
    @if (successMessage) {
      <div class="alert alert-success" style="margin-top: 1.5rem;">
        {{ successMessage }}
        <button class="alert-close" (click)="successMessage = null">×</button>
      </div>
    }

    <!-- TAB 1: Monthly Invoices -->
    @if (activeTab === 'monthly' && !isLoading && !error) {
      <div class="table-container">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Mã Căn hộ</th>
                <th>Cư dân</th>
                <th>Loại phí</th>
                <th>Số tiền</th>
                <th>Trạng thái</th>
                <th>Hạn chót</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody>
              @for (invoice of flatInvoices; track invoice.invoiceId) {
                <tr>
                  <td class="font-medium">{{ invoice.apartmentCode }}</td>
                  <td>{{ invoice.residentName || 'N/A' }}</td>
                  <td>{{ invoice.feeType }}</td>
                  <td class="font-medium">{{ formatCurrency(invoice.price) }}</td>
                  <td>
                    <span [class]="getStatusClass(invoice.status)">
                      {{ getStatusLabel(invoice.status) }}
                    </span>
                  </td>
                  <td>{{ formatDate(invoice.endDate) }}</td>
                  <td class="actions">
                    <div class="action-buttons">
                      <button class="action-view-btn" (click)="viewDetail(invoice.invoiceId)">
                        Xem Chi tiết
                      </button>
                      <button 
                        *ngIf="invoice.status === 'OVERDUE'"
                        type="button"
                        class="btn-edit"
                        (click)="openEditEndDateModal(invoice)"
                        title="Sửa ngày kết thúc">
                        Sửa
                      </button>
                    </div>
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="7" class="no-results">Không tìm thấy hóa đơn nào phù hợp.</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }

    <!-- TAB 2: One-Time Invoices -->
    @if (activeTab === 'one-time' && !isLoading && !error) {
      <div class="table-container">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Ngày tạo</th>
                <th>Căn hộ</th>
                <th>Nội dung</th>
                <th>Số tiền</th>
                <th>Trạng thái</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody>
              @for (invoice of oneTimeInvoices; track invoice.invoiceId) {
                <tr>
                  <td>{{ formatDate(invoice.startDate) }}</td>
                  <td class="font-medium">{{ invoice.apartmentCode }}</td>
                  <td>
                    @let parsed = parseDescription(invoice.description);
                    {{ parsed.itemDescription }}
                  </td>
                  <td class="font-medium">{{ formatCurrency(invoice.price) }}</td>
                  <td>
                    <span [class]="getStatusClass(invoice.status)">
                      {{ getStatusLabel(invoice.status) }}
                    </span>
                  </td>
                  <td class="actions">
                    <div class="action-buttons">
                      <button class="action-view-btn" (click)="viewDetail(invoice.invoiceId)">
                        Xem Chi tiết
                      </button>
                      <button 
                        *ngIf="invoice.status === 'OVERDUE'"
                        type="button"
                        class="btn-edit"
                        (click)="openEditEndDateModal(invoice)"
                        title="Sửa ngày kết thúc">
                        Sửa
                      </button>
                      <button 
                        *ngIf="invoice.status === 'PENDING'"
                        type="button"
                        class="btn-delete"
                        (click)="deleteInvoice(invoice.invoiceId)"
                        title="Xóa">
                        Xóa
                      </button>
                      <button 
                        *ngIf="invoice.status === 'PENDING'"
                        type="button"
                        class="btn-mark-paid"
                        (click)="markAsPaid(invoice.invoiceId)"
                        title="Thu tiền mặt">
                        Trả tiền mặt
                      </button>
                    </div>
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="6" class="no-results">Không tìm thấy hóa đơn nào phù hợp.</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }
  </div>

  <!-- Confirmation Modal -->
  @if (showConfirmModal) {
    <div class="modal-overlay" (click)="cancelAction()">
      <div class="modal-container" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3 class="modal-title">{{ confirmModalTitle }}</h3>
          <button class="modal-close" (click)="cancelAction()">×</button>
        </div>
        <div class="modal-body">
          <p>{{ confirmModalMessage }}</p>
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" (click)="cancelAction()">Hủy</button>
          <button 
            class="btn-confirm" 
            [class.btn-danger]="confirmModalType === 'delete'"
            [class.btn-success]="confirmModalType === 'markPaid'"
            (click)="confirmAction()">
            Xác nhận
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Edit End Date Modal -->
  @if (showEditEndDateModal) {
    <div class="modal-overlay" (click)="closeEditEndDateModal()">
      <div class="modal-container" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3 class="modal-title">Sửa ngày kết thúc thanh toán</h3>
          <button class="modal-close" (click)="closeEditEndDateModal()">×</button>
        </div>
        <div class="modal-body">
          @if (selectedInvoiceForEdit) {
            <div class="form-group">
              <label class="form-label">Mã căn hộ:</label>
              <p class="form-value">{{ selectedInvoiceForEdit.apartmentCode }}</p>
            </div>
            <div class="form-group">
              <label class="form-label">Ngày kết thúc hiện tại:</label>
              <p class="form-value">{{ formatDate(selectedInvoiceForEdit.endDate) }}</p>
            </div>
            <div class="form-group">
              <label for="newEndDate" class="form-label">Ngày kết thúc mới: <span class="required">*</span></label>
              <input
                type="date"
                id="newEndDate"
                class="form-input"
                [value]="newEndDate"
                (change)="onEndDateChange($event)"
                [min]="getMinDate()"
                required
              />
              <p class="form-hint">Định dạng: DD/MM/YYYY (ví dụ: 25/12/2025)</p>
              @if (editEndDateError) {
                <p class="error-message">{{ editEndDateError }}</p>
              }
            </div>
          }
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" (click)="closeEditEndDateModal()">Hủy</button>
          <button 
            class="btn-confirm btn-primary" 
            (click)="saveEndDate()"
            [disabled]="!newEndDate || isUpdatingEndDate">
            @if (isUpdatingEndDate) {
              Đang lưu...
            } @else {
              Lưu
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
