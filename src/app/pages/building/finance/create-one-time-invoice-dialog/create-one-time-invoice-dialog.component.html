<div class="dialog-overlay" (click)="closeDialog()">
  <div class="dialog-container" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2>Tạo Hóa Đơn Lẻ</h2>
      <button class="close-btn" (click)="closeDialog()" type="button">×</button>
    </div>

    <div class="dialog-body">
      @if (error) {
        <div class="alert alert-error">
          {{ error }}
        </div>
      }

      <form (ngSubmit)="onSubmit()" #invoiceForm="ngForm">
        <!-- Apartment Selection -->
        <div class="form-group">
          <label class="form-label" for="apartmentId">
            Căn hộ <span class="required">*</span>
          </label>
          <select
            id="apartmentId"
            name="apartmentId"
            class="form-select"
            [(ngModel)]="formData.apartmentId"
            required>
            <option value="">-- Chọn căn hộ --</option>
            @for (apartment of apartments; track apartment.apartmentId) {
              <option [value]="apartment.apartmentId">
                {{ apartment.code }}
              </option>
            }
          </select>
        </div>

        <!-- Fee Type Selection -->
        <div class="form-group">
          <label class="form-label" for="priceQuotationId">
            Loại phí
          </label>
          <select
            id="priceQuotationId"
            name="priceQuotationId"
            class="form-select"
            [(ngModel)]="formData.priceQuotationId"
            (change)="onQuotationChange()">
            <option [value]="null">-- Chọn loại phí --</option>
            @for (quotation of priceQuotations; track quotation.priceQuotationId) {
              <option [value]="quotation.priceQuotationId">
                {{ quotation.feeType }} - {{ formatCurrency(quotation.unitPrice) }}
              </option>
            }
            <option value="custom">Khác (Nhập tay)</option>
          </select>
        </div>

        <!-- Item Description -->
        <div class="form-group">
          <label class="form-label" for="itemDescription">
            Mô tả khoản thu <span class="required">*</span>
          </label>
          <input
            type="text"
            id="itemDescription"
            name="itemDescription"
            class="form-input"
            [(ngModel)]="formData.itemDescription"
            placeholder="VD: Phạt đỗ xe"
            required>
        </div>

        <!-- Amount -->
        <div class="form-group">
          <label class="form-label" for="amount">
            Số tiền <span class="required">*</span>
          </label>
          <input
            type="number"
            id="amount"
            name="amount"
            class="form-input"
            [(ngModel)]="formData.amount"
            min="0"
            step="1000"
            placeholder="0"
            required>
        </div>

        <!-- Note -->
        <div class="form-group">
          <label class="form-label" for="note">
            Ghi chú thêm
          </label>
          <textarea
            id="note"
            name="note"
            class="form-textarea"
            [(ngModel)]="formData.note"
            rows="3"
            placeholder="Ghi chú chi tiết..."></textarea>
        </div>

        <!-- Image Upload -->
        <div class="form-group">
          <label class="form-label" for="images">
            Ảnh bằng chứng
          </label>
          <input
            type="file"
            id="images"
            name="images"
            class="form-input"
            (change)="onFileSelected($event)"
            accept="image/*"
            multiple>
          
          @if (imagePreviews.length > 0) {
            <div class="image-preview-container">
              @for (preview of imagePreviews; track $index) {
                <div class="image-preview-item">
                  <img [src]="preview" alt="Preview">
                  <button
                    type="button"
                    class="remove-image-btn"
                    (click)="removeImage($index)">
                    ×
                  </button>
                </div>
              }
            </div>
          }
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="closeDialog()"
            [disabled]="isLoading">
            Hủy
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="isLoading || !invoiceForm.valid">
            @if (isLoading) {
              Đang tạo...
            } @else {
              Tạo Hóa Đơn
            }
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

